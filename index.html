<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Poppe’s Diesel Co. — Shop Manager v1.2.2 (Parts-Only Tax + Cloud Fix)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase client (v2 UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #e3cda7;
      --bg-dark: #d2b78a;
      --card: #f7f0e4;
      --accent: #0b3b2e;
      --accent-soft: #164b3c;
      --accent-text: #ffffff;
      --danger: #7d1c1c;
      --text-main: #222222;
      --text-soft: #444444;
      --border-soft: #c3b59f;
      --table-header: #1c1c1c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }
    h1,h2,h3,h4 { margin: 0; }

    /* Layout */
    header {
      background: #1a1208;
      color: #f8f5f0;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    header .title-block h1 {
      font-size: 20px;
      letter-spacing: 0.03em;
    }
    header .subtitle {
      font-size: 11px;
      opacity: 0.8;
    }
    header .right-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(0,0,0,0.4);
      color: #f8f5f0;
      white-space: nowrap;
    }
    .tag.selftest.ok { border-color: #7ed321; }
    .tag.selftest.warn { border-color: #f5a623; }

    main {
      padding: 10px 12px 60px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Tabs */
    .tab-bar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }
    .tab-btn {
      border: none;
      background: #111;
      color: #f5f5f5;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 13px;
    }
    .tab-btn[data-tab].active-tab {
      background: var(--accent);
    }
    .tab-btn:hover { filter: brightness(1.05); }

    .tab {
      display: none;
      background: rgba(0,0,0,0.12);
      border-radius: 12px;
      padding: 10px;
      margin-top: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }
    .tab.active { display: block; }

    /* Cards & grids */
    .card {
      background: var(--card);
      border-radius: 10px;
      padding: 10px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }

    .grid-2 {
      display: grid;
      grid-template-columns: minmax(0,1.7fr) minmax(0,1fr);
      gap: 10px;
    }
    @media (max-width: 960px) {
      .grid-2 { grid-template-columns: minmax(0,1fr); }
    }

    /* Forms / inputs */
    label {
      font-size: 12px;
      font-weight: 500;
      display: block;
      margin-bottom: 2px;
    }
    input[type="text"],
    input[type="number"],
    input[type="email"],
    textarea,
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #b5a185;
      font-size: 13px;
      background: #fdf8ef;
      color: var(--text-main);
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    input:focus, textarea:focus, select:focus {
      outline: 2px solid rgba(12,63,52,0.7);
      outline-offset: 1px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .row > .field {
      flex: 1;
      min-width: 150px;
    }
    .row > .field.small {
      max-width: 150px;
    }
    .row > .field.xsmall {
      max-width: 120px;
    }

    /* Tables */
    .table-wrap {
      overflow-x: auto;
      max-width: 100%;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      table-layout: auto; /* let browser size columns to content */
    }
    thead {
      background: var(--table-header);
      color: #f7f7f7;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(0,0,0,0.35);
      text-align: left;
      vertical-align: top;
    }
    tbody tr:nth-child(even) {
      background: rgba(0,0,0,0.04);
    }
    tbody tr:hover {
      background: rgba(0,0,0,0.06);
    }

    /* We removed rigid #lines column widths so cells can grow/wrap naturally */

    /* Badges */
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(0,0,0,0.4);
      background: #f0f0f0;
    }
    .badge-open { background: #ffe59d; }
    .badge-ip { background: #fff2c3; }
    .badge-done { background: #c2f0c2; }
    .badge.invoice {
      background: #0e543e;
      color: white;
      border-color: #0e543e;
    }
    .badge.estimate {
      background: #b38b00;
      color: white;
      border-color: #b38b00;
    }

    /* Invoice area */
    #invoice-toolbar {
      margin-bottom: 10px;
    }
    #invoice-toolbar .row.buttons {
      flex-wrap: wrap;
    }
    #invoice-toolbar .row.buttons .tab-btn {
      margin-bottom: 4px;
    }

    .totals-panel {
      background: #1f1f1f;
      color: #f7f7f7;
      border-radius: 10px;
      padding: 8px 10px;
      min-width: 260px;
      font-size: 13px;
    }
    .totals-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }
    .totals-line span:first-child { white-space: normal; }
    .totals-line strong { font-weight: 600; }
    .totals-panel .grand {
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid rgba(255,255,255,0.25);
      font-weight: 700;
    }

    .calc-hint {
      margin-top: 3px;
      font-size: 10px;
      color: #555;
    }
    .calc-hint.ok { color: #0f6a45; }
    .calc-hint.warn { color: #a35a00; }

    .drag-col { width: 40px; }
    .drag-col .handle {
      width: 32px;
      padding: 3px 0;
      text-align: center;
      font-size: 14px;
    }
    .draggable-row.dragging {
      opacity: 0.7;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
      position: relative;
      z-index: 10;
    }
    .draggable-row.drop-target {
      outline: 2px dashed #333;
    }

    .desc-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .desc-wrap .lDesc {
      width: 100%;
    }
    .desc-wrap .lNote {
      font-size: 11px;
      min-height: 38px;
    }

    /* Photo grid */
    #photoSection {
      margin-top: 10px;
    }
    #photoGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px,1fr));
      gap: 8px;
      margin-top: 6px;
    }
    .photo-item {
      background: #fdf8ef;
      border-radius: 8px;
      padding: 6px;
      border: 1px solid var(--border-soft);
    }
    .photo-item img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 4px;
    }
    .photo-item button.del {
      border: none;
      background: var(--danger);
      color: #fff;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      cursor: pointer;
      margin-bottom: 4px;
    }

    /* Preview / print area */
    #preview {
      position: relative;
      background: #ffffff;
      border-radius: 10px;
      padding: 10px 10px 14px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.25);
    }
    #preview .watermark {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 2;
      opacity: 0.35;
      background: transparent !important;
    }
    #wmImg {
      max-width: 90%;
      max-height: 90%;
      opacity: 0.35;
      display: none;
      background: transparent !important;
      mix-blend-mode: multiply;
    }
    #wmFallback {
      font-size: 40px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      opacity: 0.35;
    }
    #preview-content {
      position: relative;
      z-index: 1;
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
      margin-bottom: 6px;
    }
    .invoice-header h3 {
      font-size: 16px;
      margin: 0;
    }
    .invoice-header .meta {
      font-size: 11px;
      text-align: right;
    }

    .p-totals {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      font-size: 12px;
      gap: 8px;
    }
    .p-totals div {
      min-width: 110px;
      text-align: right;
      white-space: normal; /* allow wrapping so long labels (like Warranty hours) are not cut off */
    }

    #pOverallBlock {
      margin-top: 6px;
      font-size: 12px;
    }

    .signatures {
      margin-top: 10px;
      display: grid;
      gap: 8px;
      font-size: 11px;
    }
    .sig-row {
      display: grid;
      grid-template-columns: minmax(0,2fr) minmax(0,1.3fr);
      gap: 16px;
      align-items: flex-end;
    }
    @media (max-width: 720px) {
      .sig-row { grid-template-columns: minmax(0,1fr); }
    }
    .sig-line {
      border-bottom: 1px solid #333;
      height: 28px;
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      gap: 6px;
    }
    .sig-label {
      margin-top: 2px;
      color: #555;
    }
    .sig-img {
      max-height: 60px;
    }

    .p-photos {
      display: grid;
      grid-template-columns: repeat(3,1fr);
      gap: 6px;
      margin-top: 6px;
    }
    .p-photo {
      border: 1px solid #333;
      padding: 4px;
      border-radius: 6px;
      break-inside: avoid;
      page-break-inside: avoid;
    }
    .p-photo img {
      width: 100%;
      height: 1.8in;
      object-fit: cover;
      border-radius: 4px;
      display: block;
    }

    /* Recent jobs pill */
    #recentJobsWrap {
      margin-top: 4px;
      background: #2a2119;
      border-radius: 999px;
      padding: 4px 8px;
      color: #f7f7f7;
      font-size: 12px;
    }
    #recentJobsWrap.collapsed #recentJobs { display: none; }
    #recentJobsToggle {
      border: none;
      background: transparent;
      color: inherit;
      font-size: 12px;
      cursor: pointer;
      padding: 2px 4px;
    }
    #recentJobsToggle:hover { text-decoration: underline; }
    #recentJobs {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .recent-job-card {
      border-radius: 999px;
      border: none;
      background: rgba(0,0,0,0.7);
      color: #f7f7f7;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 11px;
    }
    .recent-job-title { font-weight: 600; }
    .recent-job-meta { opacity: 0.85; }

    /* Debug */
    #debugToggle {
      border: none;
      background: #333;
      color: #fff;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      cursor: pointer;
    }
    #debug {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 40vh;
      background: #0b0b0b;
      color: #e0e0e0;
      font-family: "SF Mono","Consolas","Menlo",monospace;
      font-size: 11px;
      padding: 6px 10px;
      overflow: auto;
      z-index: 40;
      border-top: 1px solid #555;
    }
    #debugMeta {
      font-size: 10px;
      margin-bottom: 4px;
      opacity: 0.8;
    }
    #debugLog {
      white-space: pre-wrap;
    }

    #error {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 50;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      text-align: center;
      padding: 20px;
      cursor: pointer;
    }
    #error-inner {
      max-width: 320px;
      background: #3b0000;
      border-radius: 10px;
      padding: 14px;
      border: 1px solid #ffb3b3;
    }

    /* To top button */
    #toTop {
      position: fixed;
      right: 16px;
      bottom: 18px;
      border: none;
      background: #111;
      color: white;
      padding: 8px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      display: none;
      z-index: 30;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }

    /* Modals */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 60;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .modal {
      background: #fdf8ef;
      border-radius: 10px;
      padding: 10px;
      max-width: 480px;
      width: 100%;
      border: 1px solid var(--border-soft);
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .modal-header h3 {
      font-size: 15px;
    }
    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
    }

    #sigPad {
      width: 100%;
      height: 160px;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #ffffff;
      display: block;
    }

    /* Small helpers */
    .muted { color: var(--text-soft); font-size: 11px; }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #2b1a0a;
    }

  
    /* Line-items column tweaks */
    #lines th:nth-child(2),
    #lines td:nth-child(2) {
      width: 90px;
    }
    #lines td:nth-child(2) select.lType {
      min-width: 80px;
    }
    #lines td:nth-child(3) {
      position: relative;
      overflow: visible;
    }
    .desc-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .desc-wrap .lNote {
      font-size: 11px;
      min-height: 42px;
      width: 140%;
      max-width: none;
    }


  /* === Joey 12/9/2025: tech-note spacing + watermark stacking + preview labels === */
  #lines td:nth-child(3) .desc-wrap .lNote {
    min-height: 64px;
    width: 100%;
    box-sizing: border-box;
  }
  #preview .watermark {
    z-index: 0;
  }
  #preview-content {
    position: relative;
    z-index: 1;
  }
</style>
</head>
<body>

<header>
  <div class="title-block">
    <h1>Poppe’s Diesel Co. — Shop Manager</h1>
    <div class="subtitle">v1.2.2 — Parts-Only Tax · Cloud Save/Load · Local Backup</div>
  </div>
  <div class="right-block">
    <span id="selftest" class="tag selftest">Self-test: …</span>
    <div class="tag">Watermark:
      <input type="file" id="wmFile" accept="image/*" style="font-size:10px; margin-left:4px; max-width:140px;" />
    </div>
    <button id="debugToggle">Debug</button>
  </div>
</header>

<main>
  <!-- Tab buttons -->
  <div class="tab-bar">
    <button class="tab-btn active-tab" data-tab="dashboard">Dashboard</button>
    <button class="tab-btn" data-tab="customers">Customers</button>
    <button class="tab-btn" data-tab="jobs">Jobs</button>
    <button class="tab-btn" data-tab="invoice">Invoice / Estimate</button>
    <button class="tab-btn" data-tab="settings">Settings & Backup</button>
  </div>

  <!-- Dashboard -->
  <section id="dashboard" class="tab active">
    <div class="grid-2">
      <div class="card">
        <div class="section-title">Shop Snapshot</div>
        <div class="row">
          <div class="field">
            <label>Open jobs</label>
            <div id="openJobs" style="font-size:22px; font-weight:700;">0</div>
          </div>
          <div class="field">
            <label>Unpaid invoices</label>
            <div id="unpaid" style="font-size:22px; font-weight:700;">0</div>
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label>Revenue this month</label>
            <div id="revMonth" style="font-size:18px; font-weight:600;">$0.00</div>
          </div>
          <div class="field">
            <label>Estimated profit (month)</label>
            <div id="profitMonth" style="font-size:18px; font-weight:600;">$0.00</div>
          </div>
        </div>
        <p class="muted">Based on job totals and profit estimates from current database.</p>
      </div>

      <div class="card">
        <div class="section-title">Quick Notes</div>
        <p style="font-size:13px; line-height:1.4;">
          Use the <strong>Customers</strong> tab to add vehicles & contact info, then the
          <strong>Jobs</strong> tab to start a new ticket. Build the estimate/invoice in the
          <strong>Invoice</strong> tab, and keep your data safe with the
          <strong>Settings &amp; Backup</strong> tab (local JSON backup, flash-drive save, and Supabase cloud snapshot).
        </p>
      </div>
    </div>
  </section>

  <!-- Customers -->
  <section id="customers" class="tab">
    <div class="card" style="margin-bottom:8px;">
      <div class="section-title">Add Customer</div>
      <form id="custForm">
        <div class="row">
          <div class="field">
            <label for="custName">Name</label>
            <input id="custName" type="text" placeholder="Joey Poppe" required />
          </div>
          <div class="field">
            <label for="custPhone">Phone</label>
            <input id="custPhone" type="text" placeholder="555-123-4567" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="custEmail">Email</label>
            <input id="custEmail" type="email" placeholder="customer@example.com" />
          </div>
          <div class="field">
            <label for="custVehicle">Vehicle / Notes</label>
            <input id="custVehicle" type="text" placeholder="2013 VW Touareg TDI — 210k mi" />
          </div>
        </div>
        <button type="submit" class="tab-btn">Save Customer</button>
      </form>
    </div>

    <div class="card">
      <div class="section-title">Customer List</div>
      <div class="table-wrap">
        <table id="custTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Email</th>
              <th>Vehicle</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody><!-- filled by JS --></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Jobs -->
  <section id="jobs" class="tab">
    <div class="card" style="margin-bottom:8px;">
      <div class="section-title">New Job / Ticket</div>
      <form id="jobForm">
        <div class="row">
          <div class="field">
            <label for="jobCustomer">Customer</label>
            <select id="jobCustomer">
              <option value="">Select…</option>
            </select>
          </div>
          <div class="field">
            <label for="jobTitle">Job title</label>
            <input id="jobTitle" type="text" placeholder="Oil change &amp; tune-up" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="jobVIN">VIN</label>
            <input id="jobVIN" type="text" placeholder="17-digit VIN" />
          </div>
          <div class="field xsmall">
            <label>&nbsp;</label>
            <button type="button" id="decodeVIN" class="tab-btn">Decode VIN &amp; Suggest Template</button>
          </div>
        </div>

        <div id="vinResult" class="muted" style="display:none;"></div>
        <div id="vinSuggest" style="display:none; margin-top:4px;">
          <div class="muted">Suggested service templates:</div>
          <div id="vinTags" style="margin-top:4px; display:flex; flex-wrap:wrap; gap:4px;"></div>
          <button type="button" id="addAllSuggest" class="tab-btn" style="margin-top:4px;">Add All Suggestion Templates</button>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="field">
            <label for="jobNotes">Job notes (intake)</label>
            <textarea id="jobNotes" placeholder="Customer complaint, symptoms, etc."></textarea>
          </div>
          <div class="field small">
            <label for="jobStatus">Status</label>
            <select id="jobStatus">
              <option>Open</option>
              <option>In Progress</option>
              <option>Done</option>
            </select>
          </div>
        </div>

        <button type="submit" class="tab-btn">Create Job</button>
      </form>
    </div>

    <div class="card">
      <div class="section-title">All Jobs</div>
      <div class="table-wrap">
        <table id="jobsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Customer</th>
              <th>Title</th>
              <th>Status</th>
              <th>Subtotal</th>
              <th>Profit</th>
              <th>Open</th>
            </tr>
          </thead>
          <tbody><!-- filled by JS --></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Invoice -->
  <section id="invoice" class="tab">
    <div id="invoice-toolbar" class="card">
      <div class="row">
        <div class="field">
          <label for="invCustFilter">Filter by Customer</label>
          <select id="invCustFilter">
            <option value="">All customers</option>
          </select>
        </div>
        <div class="field">
          <label for="invJobSearch">Search Jobs</label>
          <input id="invJobSearch" type="text" placeholder="Type to filter jobs by customer, VIN, notes…" />
        </div>
        <div class="field">
          <label for="invJob">Job</label>
          <select id="invJob">
            <option value="">Select job…</option>
          </select>
        </div>
        <div class="field xsmall">
          <label for="docType">Type</label>
          <select id="docType">
            <option>Estimate</option>
            <option>Invoice</option>
          </select>
        </div>
        <div class="field xsmall">
          <label for="invNo">Document #</label>
          <input id="invNo" type="text" placeholder="(e.g., 2025-001)" />
        </div>
      </div>

      <div class="row">
        <div class="field xsmall">
          <label for="laborRate">Labor Rate ($/hr)</label>
          <input id="laborRate" type="number" step="0.01" value="80" />
        </div>
        <div class="field xsmall">
          <label for="markupFactor">Markup (x cost, parts)</label>
          <input id="markupFactor" type="number" step="0.01" value="1.40" />
        </div>
        <div class="field xsmall">
          <label for="salesTax">Sales Tax (%)</label>
          <input id="salesTax" type="number" step="0.01" value="7" />
        </div>
        <div class="field">
          <label for="payLink">Payment Link</label>
          <input id="payLink" type="text" placeholder="https://pay.yourprovider.com/…" />
        </div>
        <div class="field">
          <label for="emailTo">Email To</label>
          <input id="emailTo" type="email" placeholder="customer@example.com" />
        </div>
      </div>

      <div class="row buttons" style="margin-top:6px;">
        <button type="button" id="addLabor" class="tab-btn">+ Labor Line</button>
        <button type="button" id="addPart" class="tab-btn">+ Part Line</button>
        <button type="button" id="applyMarkup" class="tab-btn">Apply Default Markup</button>
        <button type="button" id="quickEstimate" class="tab-btn">Quick Estimate</button>
        <button type="button" id="recalc" class="tab-btn">Recalculate</button>
        <button type="button" id="markPaid" class="tab-btn" style="background:var(--accent);">Mark Paid</button>
        <button type="button" id="approve" class="tab-btn">Approve Estimate</button>
        <button type="button" id="convert" class="tab-btn">Convert to Invoice</button>
        <button type="button" id="sign" class="tab-btn">Collect Signatures</button>
        <button type="button" id="email" class="tab-btn">Email</button>
      </div>

      <div id="recentJobsWrap" class="collapsed">
        <button id="recentJobsToggle">Recent Jobs (click to expand)</button>
        <div id="recentJobs"></div>
      </div>
    </div>

    <div class="grid-2" style="margin-top:8px;">
      <!-- Lines + totals -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:8px; margin-bottom:4px;">
          <div class="section-title">Line Items</div>
          <div class="totals-panel">
            <div class="totals-line"><span>Subtotal:</span> <span id="sub">$0.00</span></div>
            <div class="totals-line"><span>Tax (Parts only):</span> <span id="tax">$0.00</span></div>
            <div class="totals-line grand"><span>Total:</span> <span id="grand">$0.00</span></div>
            <div class="totals-line"><span>Total Profit:</span> <span id="profit">$0.00</span></div>
            <div class="totals-line"><span>Total Savings vs List:</span> <span id="save">$0.00</span></div>
            <div class="totals-line"><span>Warranty hours (not billed):</span> <span id="wHours">0.00</span></div>
            <div class="totals-line">
              <span>Margin:</span>
              <span id="margin" class="badge estimate">0%</span>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table id="lines">
            <thead>
              <tr>
                <th class="drag-col">⇅</th>
                <th>Type</th>
                <th>Description / Note</th>
                <th>Qty/Hrs</th>
                <th>List $</th>
                <th>Cost $</th>
                <th>Unit $</th>
                <th>Line $</th>
                <th>Line Profit $</th>
                <th>×</th>
              </tr>
            </thead>
            <tbody><!-- JS fills --></tbody>
          </table>
        </div>

        <div style="margin-top:8px;">
          <div class="section-title">Technician Overall Notes</div>
          <textarea id="overallNotes" placeholder="Explain diagnostics, verified checks, advisories."></textarea>
        </div>

        <div style="margin-top:8px;">
          <div class="section-title">Internal Notes (shop-only)</div>
          <textarea id="internalNotes" placeholder="Private notes for you / techs (won’t print)."></textarea>
        </div>

        <div id="photoSection">
          <div class="section-title">Work Photos</div>
          <div class="row">
            <div class="field">
              <label for="photoInput">Attach Photos</label>
              <input id="photoInput" type="file" accept="image/*" multiple />
            </div>
            <div class="field">
              <label><input type="checkbox" id="photosOnPdf" checked /> Include photos on PDF</label>
              <div class="muted">Each photo can be toggled on/off below.</div>
            </div>
          </div>
          <div id="photoGrid"></div>
        </div>

        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
          <button type="button" id="pdf" class="tab-btn" style="background:#b22222;">Generate PDF</button>
        </div>
      </div>

      <!-- Preview -->
      <div class="card">
        <div class="section-title">Preview (Print Layout)</div>
        <div id="preview">
          <div class="watermark">
            <img id="wmImg" alt="Watermark" />
            <div id="wmFallback">POPPE’S DIESEL CO.</div>
          </div>
          <div id="preview-content">
            <div class="invoice-header">
              <div>
                <h3><span id="pType" class="badge estimate">Estimate</span> <span id="pInvNo">DRAFT</span></h3>
                <div style="font-size:11px; margin-top:4px;">
                  <strong>Bill To:</strong> <span id="pCust">—</span><br/>
                  <span id="pVeh"></span>
                </div>
              </div>
              <div class="meta">
                <div>Date: <span id="pDate"></span></div>
                <div>Status: <span id="pStatus"></span></div>
              </div>
            </div>

            <table>
              <thead>
                <tr>
                  <th>Description</th>
                  <th style="width:50px;">Qty</th>
                  <th style="width:120px;">Unit</th>
                  <th style="width:90px;">Line</th>
                </tr>
              </thead>
              <tbody id="pLines"></tbody>
            </table>

            <div class="p-totals">
              <div>Subtotal: <span id="pSub">$0.00</span></div>
              <div>Tax: <span id="pTax">$0.00</span></div>
              <div><strong>Total: <span id="pGrand">$0.00</span></strong></div>
              <div>Savings: <span id="pSave">$0.00</span></div>
              <div>Warranty hours (not billed): <span id="pWHours">0.00</span></div>
            </div>

            <div id="pOverallBlock"></div>

            <div class="signatures">
              <div class="sig-row">
                <div>
                  <div class="sig-line">
                    <img id="pSigCustomer" class="sig-img" alt="Customer Signature" />
                  </div>
                  <div class="sig-label">
                    Customer Signature
                    <span id="pSigCustomerName"></span>
                    <span id="pSigCustomerDate"></span>
                  </div>
                </div>
                <div>
                  <div class="sig-line">
                    <img id="pSigManager" class="sig-img" alt="Manager Signature" />
                  </div>
                  <div class="sig-label">
                    Shop Representative
                    <span id="pSigManagerName"></span>
                    <span id="pSigManagerDate"></span>
                  </div>
                </div>
              </div>
            </div>

            <div id="pPhotosBlock"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Settings / Backup -->
  <section id="settings" class="tab">
    <div class="grid-2">
      <div class="card">
        <div class="section-title">Shop Defaults</div>
        <div class="row">
          <div class="field small">
            <label for="defaultMarkup">Default markup % (parts)</label>
            <input id="defaultMarkup" type="number" step="0.01" value="40" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="shopFrom">Shop Name / From line</label>
            <input id="shopFrom" type="text" placeholder="Poppe’s Diesel Co." />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="shopReply">Reply-To Email</label>
            <input id="shopReply" type="email" placeholder="poppedieselco@gmail.com" />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="shopSubj">Email Subject Prefix</label>
            <input id="shopSubj" type="text" placeholder="[Poppe’s Diesel Co.] " />
          </div>
        </div>
        <div class="row">
          <div class="field">
            <label for="shopFooter">Email Footer</label>
            <textarea id="shopFooter" placeholder="Thank you for supporting local."></textarea>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Backup / Restore</div>
        <p style="font-size:13px; margin-bottom:6px;">
          <strong>Local JSON backup</strong> includes all customers, jobs, line items,
          notes, photos, signatures, settings, and UI state.
        </p>
        <div class="row">
          <button type="button" id="exportBtn" class="tab-btn">Export JSON Backup</button>
          <label class="tab-btn" style="cursor:pointer;">
            Import Backup
            <input id="importFile" type="file" accept="application/json" style="display:none;" />
          </label>
          <button type="button" id="importBtn" class="tab-btn">Run Import</button>
        </div>

        <hr style="margin:8px 0; border:none; border-top:1px solid var(--border-soft);" />

        <p style="font-size:13px; margin-bottom:6px;">
          <strong>Flash-drive Save</strong> (browser File System Access, Chromium-based):
        </p>
        <div class="row">
          <button type="button" id="fsChoose" class="tab-btn">Choose Save File</button>
          <button type="button" id="fsQuickSave" class="tab-btn">Quick Save to File</button>
        </div>

        <hr style="margin:8px 0; border:none; border-top:1px solid var(--border-soft);" />

        <p style="font-size:13px; margin-bottom:6px;">
          <strong>Supabase Cloud Snapshot</strong> (single row keyed by ID: <code>main</code>):
        </p>
        <div class="row">
          <button type="button" id="cloudSaveBtn" class="tab-btn">Cloud Save</button>
          <button type="button" id="cloudLoadBtn" class="tab-btn">Cloud Load</button>
        </div>
        <p class="muted">
          Cloud save/load round-trips the entire app state: customers, jobs, all lines
          (labor &amp; parts, list/cost/unit/notes), overall notes, internal notes, photos,
          signatures, settings, UI (where useful), and watermark.
        </p>
      </div>
    </div>
  </section>
</main>

<!-- Debug panel -->
<div id="debug">
  <div id="debugMeta"></div>
  <pre id="debugLog"></pre>
</div>

<!-- Fatal error overlay -->
<div id="error">
  <div id="error-inner">
    <strong>Something went sideways.</strong>
    <p style="margin-top:4px;">Tap anywhere to reload the app.</p>
  </div>
</div>

<button id="toTop">Back to top ↑</button>

<!-- Quick Estimate Modal -->
<div id="qeModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Quick Estimate</h3>
      <button type="button" id="qeClose" class="modal-close">&times;</button>
    </div>
    <div style="font-size:13px;">
      <div class="row">
        <div class="field">
          <label for="qeTitle">Title / Job summary</label>
          <input id="qeTitle" type="text" placeholder="e.g., Front brakes & rotors" />
        </div>
      </div>
      <div class="row">
        <div class="field small">
          <label for="qeHours">Labor hours</label>
          <input id="qeHours" type="number" step="0.1" value="1.5" />
        </div>
        <div class="field small">
          <label for="qePartsCost">Total parts cost ($)</label>
          <input id="qePartsCost" type="number" step="0.01" value="0" />
        </div>
        <div class="field small">
          <label for="qeMarkup">Markup %</label>
          <input id="qeMarkup" type="number" step="0.1" value="40" />
        </div>
      </div>

      <div class="row" style="margin-top:6px; justify-content:flex-end;">
        <button type="button" id="qeApplyAppend" class="tab-btn">Append to Lines</button>
        <button type="button" id="qeApplyReplace" class="tab-btn" style="background:#7d1c1c;">Replace Lines</button>
      </div>
    </div>
  </div>
</div>

<!-- Signature Modal -->
<div id="sigModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Collect Signature</h3>
      <button type="button" id="sigClose" class="modal-close">&times;</button>
    </div>
    <div style="font-size:13px;">
      <div class="row">
        <div class="field small">
          <label for="sigRole">Role</label>
          <select id="sigRole">
            <option value="customer">Customer</option>
            <option value="manager">Shop Representative</option>
          </select>
        </div>
        <div class="field">
          <label for="sigName">Name (optional)</label>
          <input id="sigName" type="text" />
        </div>
        <div class="field small">
          <label for="sigDate">Date</label>
          <input id="sigDate" type="date" />
        </div>
      </div>

      <canvas id="sigPad" width="600" height="180"></canvas>

      <div class="row" style="margin-top:6px; justify-content:flex-end;">
        <button type="button" id="sigClear" class="tab-btn">Clear</button>
        <button type="button" id="sigSave" class="tab-btn" style="background:var(--accent);">Save Signature</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------- Supabase Cloud Config ---------------- */
var SUPABASE_URL = 'https://hhbrbkyfryjidworupvf.supabase.co';
var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhoYnJia3lmcnlqaWR3b3J1cHZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MzI3NTEsImV4cCI6MjA3OTAwODc1MX0.NCU-_2RlP8-5w5w0g10Q5HrFgPW9hyfyN7D87s_BWw';

var supabaseClient = null;
var SHOP_STATE_ID = 'main';

if (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY) {
  try {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('Supabase client initialized');
  } catch (e) {
    console.error('Failed to init Supabase', e);
  }
} else {
  console.warn('Supabase not configured (no URL/key or script not loaded).');
}

/* -------------- Minimal debug harness -------------- */
(function(){
  var logEl  = document.getElementById('debugLog');
  var metaEl = document.getElementById('debugMeta');
  var buf = [];

  function print(line){
    buf.push(line);
    if (logEl) {
      logEl.textContent = buf.join('\n');
    }
  }

  window.AppLog = {
    info: function(msg){
      try { console.log('[INFO]', msg); } catch(e) {}
      print('[INFO] ' + msg);
    },
    warn: function(msg){
      try { console.warn('[WARN]', msg); } catch(e) {}
      print('[WARN] ' + msg);
    },
    error: function(msg, err){
      try { console.error('[ERROR]', msg, err); } catch(e) {}
      print('[ERROR] ' + msg + (err ? (' :: ' + (err.message || err)) : ''));
    }
  };

  if (metaEl){
    try {
      var lang = navigator.language || navigator.userLanguage || 'n/a';
      metaEl.textContent =
        'UA=' + navigator.userAgent +
        ' | Lang=' + lang +
        ' | ' + (new Date()).toLocaleString();
    } catch(_) {}
  }

  var dbg = document.getElementById('debugToggle');
  if (dbg){
    dbg.addEventListener('click', function(){
      var box = document.getElementById('debug');
      if (!box) return;
      box.style.display = (box.style.display === 'block' ? 'none' : 'block');
    });
  }
})();;

function guard(name, fn){
  try {
    fn();
    AppLog.info(name + ' ✅');
  } catch(e) {
    // Log errors but do not block the UI with the overlay; use Debug panel instead.
    AppLog.error(name + ' ❌', e);
  }
}

if (!window.crypto) window.crypto = {};
if (!window.crypto.randomUUID){
  window.crypto.randomUUID = function(){ return 'id-' + Math.random().toString(16).slice(2) + '-' + Date.now(); };
}

/* Watermark cache */
(function(){
  var KEY = 'pdc_wm_dataurl';
  var imgEl = document.getElementById('wmImg');
  var fallback = document.getElementById('wmFallback');
  function setWM(src){ if(!imgEl) return; imgEl.src = src; imgEl.style.display = 'block'; if(fallback) fallback.style.display = 'none'; }
  try {
    var cached = localStorage.getItem(KEY);
    if(cached){ setWM(cached); }
  } catch(_){}
  var up = document.getElementById('wmFile');
  function readAsDataURL(file, cb, eb){
    var r = new FileReader();
    r.onload=function(){cb(r.result)};
    r.onerror=function(){ if(eb) eb(r.error); };
    r.readAsDataURL(file);
  }
  if(up) up.addEventListener('change', function(){
    var f = up.files && up.files[0];
    if(!f) return;
    readAsDataURL(f, function(data){
      try{ localStorage.setItem(KEY, data); }catch(_){}
      setWM(data);
      alert('Watermark updated.');
      up.value='';
    });
  });
})();

/* -------------- App init -------------- */
window.addEventListener('load', function(){
  guard('init', function(){

    var STORAGE_KEY = 'poppe_shop_db_v112';

    function loadDB(){
      try {
        var s = localStorage.getItem(STORAGE_KEY);
        return s ? JSON.parse(s) : null;
      } catch(e){
        AppLog.error('localStorage load failed', e);
        return null;
      }
    }

    function saveDB(){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
      } catch(e){
        AppLog.error('localStorage save failed', e);
      }
    }

    function defaultDB(){
      return {
        customers: [],
        jobs: [],
        templates: seedTemplates(),
        settings: {
          defaultMarkup: 40,
          shopFrom:'Poppe’s Diesel Co.',
          shopReply:'poppedieselco@gmail.com',
          shopSubj:'[Poppe’s Diesel Co.] ',
          shopFooter:'Thank you for supporting local.'
        }
      };
    }

    function seedTemplates(){
      return [
        { platform: "Cummins 6.7L (Ram)", items: [
          {type:"Labor", desc:"Oil & Filters Service", qty:1.0, unit:null},
          {type:"Part", desc:"Fuel Filter (Primary)", vendor:"Fleetguard", part:"FS53000", cost:38.00, markup:40},
          {type:"Part", desc:"Fuel Filter (Secondary)", vendor:"Fleetguard", part:"FF63009", cost:32.00, markup:40},
          {type:"Part", desc:"Oil Filter", vendor:"Fleetguard", part:"LF16035", cost:9.50, markup:60},
          {type:"Part", desc:"Crankcase Filter", vendor:"Cummins", part:"CV50628", cost:78.00, markup:35}
        ]},
        { platform: "Powerstroke 6.7L (Ford)", items: [
          {type:"Labor", desc:"Fuel Filters & Oil", qty:1.2, unit:null},
          {type:"Part", desc:"Fuel Filter (Frame)", vendor:"Motorcraft", part:"FD-4625", cost:34.00, markup:40},
          {type:"Part", desc:"Fuel Filter (Engine Bay)", vendor:"Motorcraft", part:"FD-4624", cost:28.00, markup:40},
          {type:"Part", desc:"Oil Filter", vendor:"Motorcraft", part:"FL-2051S", cost:12.50, markup:60}
        ]},
        { platform: "Duramax L5P (GM)", items: [
          {type:"Labor", desc:"Fuel Filter & Air", qty:1.0, unit:null},
          {type:"Part", desc:"Fuel Filter", vendor:"ACDelco", part:"TP1015", cost:36.00, markup:40},
          {type:"Part", desc:"Air Filter", vendor:"ACDelco", part:"A3218C", cost:22.00, markup:55},
          {type:"Part", desc:"Trans Service Kit", vendor:"ACDelco", part:"24296954", cost:89.00, markup:35}
        ]}
      ];
    }

    var DB = loadDB() || defaultDB();

    // Normalize DB shape in case older or partial data is stored
    if (!DB || typeof DB !== 'object') {
      DB = defaultDB();
    }
    if (!Array.isArray(DB.customers)) DB.customers = [];
    if (!Array.isArray(DB.jobs)) DB.jobs = [];
    if (!Array.isArray(DB.templates)) DB.templates = seedTemplates();
    if (!DB.settings) DB.settings = defaultDB().settings;



    var UIKEY = 'pdc_ui_state';
    function loadUI(){
      try { return JSON.parse(localStorage.getItem(UIKEY)||'{}'); }
      catch(_){ return {}; }
    }
    function saveUI(u){
      try { localStorage.setItem(UIKEY, JSON.stringify(u)); }
      catch(_){}
    }
    var UI = loadUI();

    function upgradeDB(){
      var i, j, l;
      for(i=0;i<(DB.jobs||[]).length;i++){
        j = DB.jobs[i];
        if(!j.createdAt) j.createdAt = new Date().toISOString();
        if(typeof j.overallNotes==='undefined') j.overallNotes='';
        if(typeof j.internalNotes==='undefined') j.internalNotes='';
        if(!j.photos) j.photos=[];
        if(!j.signatures) j.signatures={customer:null, manager:null};
        if(!j.docType) j.docType='Estimate';
        if(typeof j.paid==='undefined') j.paid=false;
        if(!j.lines) j.lines=[];
        for(l=0;l<(j.lines||[]).length;l++){
          if(typeof j.lines[l].note==='undefined') j.lines[l].note='';
          if(typeof j.lines[l].list==='undefined') j.lines[l].list=0;
          if(typeof j.lines[l].cost==='undefined') j.lines[l].cost=0;
          if(typeof j.lines[l].unit==='undefined') j.lines[l].unit=0;
        }
        // Clean out any completely empty placeholder lines from older data
        j.lines = cleanLines(j.lines || []);
      }
      if(!DB.settings) DB.settings = defaultDB().settings;
      saveDB();
    }

    /* ------ Global helpers ------ */
    function $(sel, root){ return (root||document).querySelector(sel); }
    function $all(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
    function fmt(n){ return "$"+Number(n||0).toFixed(2); }
    function matchesAllTokens(hay, q){
      var tokens = (q||'').replace(/\s+/g,' ').toLowerCase().split(' ');
      var text = String(hay||'').toLowerCase();
      for(var i=0;i<tokens.length;i++){ if(tokens[i] && text.indexOf(tokens[i])===-1) return false; }
      return true;
    }

    /* ------ Backup payload (used by export, FS, Supabase) ------ */
    function buildBackupPayload(){
      var payload = {
        _note: 'Poppe’s Diesel Co. Shop Manager backup',
        version: 'v1.2.2',
        exportedAt: new Date().toISOString(),
        db: DB,
        ui: UI,
        wm: null
      };
      try {
        payload.wm = localStorage.getItem('pdc_wm_dataurl') || null;
      } catch(_){}
      return payload;
    }

    /* ------ Render helpers ------ */
    function renderDashboard(){
      var openJobs = 0, unpaid = 0, revMonth = 0, profitMonth = 0;
      var now = new Date();
      var ym = now.getFullYear() + '-' + (now.getMonth()+1);
      for(var i=0;i<DB.jobs.length;i++){
        var j = DB.jobs[i];
        if(j.status==='Open') openJobs++;
        if(j.docType==='Invoice' && !j.paid) unpaid++;
        var subtotal = sumLines(j.lines, 'subtotal');
        var profit = sumLines(j.lines, 'profit');
        var d = j.createdAt ? new Date(j.createdAt) : now;
        var key = d.getFullYear() + '-' + (d.getMonth()+1);
        if(key===ym){
          revMonth += subtotal;
          profitMonth += profit;
        }
      }
      $('#openJobs').textContent = openJobs;
      $('#unpaid').textContent = unpaid;
      $('#revMonth').textContent = fmt(revMonth);
      $('#profitMonth').textContent = fmt(profitMonth);
    }

    function renderSettings(){
      $('#defaultMarkup').value = DB.settings.defaultMarkup != null ? DB.settings.defaultMarkup : 40;
      $('#shopFrom').value   = DB.settings.shopFrom   || '';
      $('#shopReply').value  = DB.settings.shopReply  || '';
      $('#shopSubj').value   = DB.settings.shopSubj   || '';
      $('#shopFooter').value = DB.settings.shopFooter || '';
    }

    // Stubbed photo grid renderer to avoid init crashes when legacy photo features are not present
    function renderPhotoGrid(){
      // No-op: photo grid removed in this version, but calls may still exist in older job flows
      return;
    }

    function renderAll(){
      renderCustomers();
      renderJobs();
      renderJobCustomer();
      renderDashboard();
      renderSettings();
      saveDB();
    }

    /* ------ Tabs (and save lines when switching) ------ */
    $all('.tab-btn[data-tab]').forEach(function(b){
      b.addEventListener('click', function(){
        try{ persistLines(); }catch(_){}
        var id = b.getAttribute('data-tab');
        $all('.tab').forEach(function(t){ t.classList.remove('active'); });
        document.getElementById(id).classList.add('active');
        $all('.tab-btn[data-tab]').forEach(function(x){ x.classList.remove('active-tab'); });
        b.classList.add('active-tab');
        UI.activeTab = id;
        saveUI(UI);
        try{ window.scrollTo(0,0); }catch(_){}
      });
    });
    if (UI.activeTab && document.getElementById(UI.activeTab)) {
      $all('.tab').forEach(function(t){ t.classList.remove('active'); });
      document.getElementById(UI.activeTab).classList.add('active');
      $all('.tab-btn[data-tab]').forEach(function(x){
        if(x.getAttribute('data-tab')===UI.activeTab) x.classList.add('active-tab');
      });
    }

    /* ------ Customers ------ */
    $('#custForm').addEventListener('submit', function(e){
      e.preventDefault();
      var c = {
        id: crypto.randomUUID(),
        name: $('#custName').value.trim(),
        phone: $('#custPhone').value.trim(),
        email: $('#custEmail').value.trim(),
        vehicle: $('#custVehicle').value.trim()
      };
      if(!c.name) return;
      DB.customers.push(c);
      renderCustomers();
      renderJobCustomer();
      this.reset();
      saveDB();
    });

    function renderCustomers(){
      var tb = $('#custTable tbody'); tb.innerHTML='';
      DB.customers.forEach(function(c){
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>'+c.name+'</td>'+
          '<td>'+(c.phone||'')+'</td>'+
          '<td>'+(c.email||'')+'</td>'+
          '<td>'+(c.vehicle||'')+'</td>'+
          '<td><button class="tab-btn" data-delc="'+c.id+'">Delete</button></td>';
        tb.appendChild(tr);
      });
      $all('button[data-delc]').forEach(function(btn){
        btn.addEventListener('click', function(){
          var id = btn.getAttribute('data-delc');
          if(!confirm('Delete this customer and all their jobs?')) return;
          DB.jobs = DB.jobs.filter(function(j){ return j.customerId !== id; });
          DB.customers = DB.customers.filter(function(c){ return c.id !== id; });
          renderCustomers(); renderJobs(); renderJobCustomer(); saveDB();
        });
      });
    }

    /* ------ Jobs ------ */
    function findCustomer(id){
      var i;
      for(i=0;i<DB.customers.length;i++){
        if(DB.customers[i].id===id) return DB.customers[i];
      }
      return null;
    }

    function renderJobCustomer(){
      var sel = $('#jobCustomer');
      var opts = ['<option value="">Select...</option>'];
      DB.customers.forEach(function(c){ opts.push('<option value="'+c.id+'">'+c.name+'</option>'); });
      sel.innerHTML = opts.join('');
      renderInvFilters();
      renderInvJobOptions();
      renderRecentJobs();
    }

    $('#jobForm').addEventListener('submit', function(e){
      e.preventDefault();
      var j = {
        id: crypto.randomUUID(),
        customerId: $('#jobCustomer').value,
        title: $('#jobTitle').value.trim(),
        vin: $('#jobVIN').value.trim(),
        notes: $('#jobNotes').value.trim(),
        status: $('#jobStatus').value,
        lines: [],
        paid:false, paidAt:null,
        docType:'Estimate',
        approved:false, approvedAt:null,
        paymentLink:'',
        vinData:null,
        overallNotes:'',
        internalNotes:'',
        photos:[],
        signatures:{customer:null, manager:null},
        createdAt:new Date().toISOString()
      };
      if(!j.customerId || !j.title) return;
      DB.jobs.push(j);
      renderJobs();
      renderJobCustomer();
      document.getElementById('jobForm').reset();
      $('#vinResult').style.display='none';
      $('#vinSuggest').style.display='none';
      saveDB();
      if(DB.jobs.length===1){
        $('#invJob').value = j.id;
        loadInvoice(j.id);
        UI.lastJobId = j.id;
        saveUI(UI);
      }
    });

    // VIN decode
    $('#decodeVIN').addEventListener('click', function(){
      var vin = $('#jobVIN').value.trim();
      var box = $('#vinResult');
      var sug = $('#vinSuggest');
      var tags = $('#vinTags');
      box.style.display='block';
      box.textContent = 'Decoding…';
      sug.style.display='none';
      tags.innerHTML='';
      if(!vin || vin.length<11){
        box.textContent='Enter a valid VIN (17 preferred).';
        return;
      }
      var xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVin/'+encodeURIComponent(vin)+'?format=json', true);
      xhr.onreadystatechange = function(){
        if(xhr.readyState===4){
          if(xhr.status>=200 && xhr.status<300){
            try{
              var data = JSON.parse(xhr.responseText||'{}');
              var map={}, i, r;
              for(i=0;i<(data.Results||[]).length;i++){
                r=data.Results[i];
                if(r.Variable && r.Value) map[r.Variable]=r.Value;
              }
              var summary = (map['Model Year']||'-')+' '+(map['Make']||'-')+' '+(map['Model']||'-');
              box.innerHTML = '<strong>'+summary+'</strong>';
              var platformText = (summary+' '+(map['Engine Model']||'')+' '+(map['Engine Manufacturer']||'')).toLowerCase();
              var matched = DB.templates.filter(function(t){
                var p = t.platform.toLowerCase();
                return (p.indexOf('cummins')>-1 && platformText.indexOf('ram')>-1) ||
                       (p.indexOf('powerstroke')>-1 && platformText.indexOf('ford')>-1) ||
                       (p.indexOf('duramax')>-1 && (platformText.indexOf('chevrolet')>-1||platformText.indexOf('gmc')>-1||platformText.indexOf('gm')>-1));
              });
              if(!matched.length) matched = DB.templates.slice(0);
              tags.innerHTML='';
              matched.forEach(function(tpl){
                var b=document.createElement('button');
                b.className='tab-btn';
                b.type='button';
                b.textContent=tpl.platform;
                b.addEventListener('click', function(){ applyTemplate(tpl); });
                tags.appendChild(b);
              });
              document.getElementById('addAllSuggest').onclick = function(){
                for(var k=0;k<matched.length;k++){ applyTemplate(matched[k]); }
              };
              sug.style.display='block';
              saveDB();
            }catch(e){
              box.textContent='VIN parse failed.';
            }
          } else {
            box.textContent='VIN decode failed.';
          }
        }
      };
      xhr.send(null);
    });

    function applyTemplate(tpl){
      if(!tpl || !tpl.items) return;
      ensureJobSelected(true);
      for(var i=0;i<tpl.items.length;i++){
        var it = tpl.items[i];
        if(it.type === 'Labor'){
          addLine('Labor', it.desc || '', it.qty || 1, 0, 0, Number($('#laborRate').value || 80), '');
        } else {
          var cost = Number(it.cost || 0);
          var mu = typeof it.markup === 'number'
            ? (it.markup/100)
            : (Number($('#defaultMarkup').value||DB.settings.defaultMarkup||40)/100);
          var unit = cost * (1+mu);
          var desc = it.desc || '';
          if(it.vendor || it.part){
            desc += ' — ' + [it.vendor, it.part].filter(Boolean).join(' ');
          }
          addLine('Part', desc, 1, 0, cost, unit, '');
        }
      }
      persistLines();
    }

    function sumLines(lines, mode){
      var subtotal=0, profit=0, i, l;
      for(i=0;i<(lines||[]).length;i++){
        l = lines[i];
        var line = Number(l.qty||0)*Number(l.unit||0);
        subtotal += line;
        profit   += Number(l.qty||0)*(Number(l.unit||0) - Number(l.cost||0));
      }
      return mode==='profit'?profit:subtotal;
    }

    function cleanLines(lines){
      return (lines || []).filter(function(l){
        if(!l) return false;
        var desc = (l.desc || '').trim();
        var note = (l.note || '').trim();
        var qty  = Number(l.qty  || 0);
        var list = Number(l.list || 0);
        var cost = Number(l.cost || 0);
        var unit = Number(l.unit || 0);
        // Drop lines that are truly empty placeholders:
        // no description, no note, and no money values set,
        // and qty is 0 or 1 (old zombie rows).
        if(!desc && !note && list===0 && cost===0 && unit===0 && (qty===0 || qty===1)) return false;
        return true;
      });
    }


    function renderJobs(){
      var tb = $('#jobsTable tbody'); tb.innerHTML='';
      DB.jobs.forEach(function(j){
        var c = findCustomer(j.customerId);
        var subtotal = sumLines(j.lines, 'subtotal');
        var profit   = sumLines(j.lines, 'profit');
        var badge = j.status==='Open' ? 'badge-open' : (j.status==='In Progress'?'badge-ip':'badge-done');
        var tr = document.createElement('tr');
        tr.innerHTML =
          '<td>'+j.id.slice(0,8)+'</td>'+
          '<td>'+(c?c.name:'—')+'</td>'+
          '<td>'+j.title+'</td>'+
          '<td><span class="badge '+badge+'">'+j.status+'</span></td>'+
          '<td>'+fmt(subtotal)+'</td>'+
          '<td>'+fmt(profit)+'</td>'+
          '<td><button class="tab-btn" data-open="'+j.id+'">Open</button></td>';
        tb.appendChild(tr);
      });
      $all('button[data-open]').forEach(function(b){
        b.addEventListener('click', function(){
          try{ persistLines(); }catch(_){}
          var id = b.getAttribute('data-open');
          document.querySelector('[data-tab="invoice"]').click();
          $('#invJob').value = id;
          loadInvoice(id);
          UI.lastJobId=id;
          saveUI(UI);
        });
      });
    }

    $('#internalNotes').addEventListener('input', function(){
      var j = currentJob(); if(!j) return;
      j.internalNotes = this.value;
      saveDB();
    });

    /* ------ Invoice filters & selectors ------ */
    function renderInvFilters(){
      var sel = $('#invCustFilter');
      var opts = ['<option value="">All customers</option>'];
      DB.customers.forEach(function(c){ opts.push('<option value="'+c.id+'">'+c.name+'</option>'); });
      sel.innerHTML = opts.join('');
    }

    function renderInvJobOptions(){
      var invSel = $('#invJob');
      var cid = $('#invCustFilter').value || '';
      var q = ($('#invJobSearch').value || '').trim().toLowerCase();
      var jobs = DB.jobs.filter(function(j){
        if(cid && j.customerId!==cid) return false;
        if(!q) return true;
        var cust = findCustomer(j.customerId);
        var fields = [(cust?cust.name:''), (j.title||''), (j.vin||''), (j.notes||''), (j.overallNotes||'')].join(' | ');
        return matchesAllTokens(fields, q);
      });
      var opts = ['<option value="">Select job…</option>'];
      jobs.forEach(function(j){
        var c = findCustomer(j.customerId);
        opts.push('<option value="'+j.id+'">'+(c?c.name:'—')+' — '+j.title+'</option>');
      });
      invSel.innerHTML = opts.join('');
    }

    function renderRecentJobs(){
      var box = $('#recentJobs'); if(!box) return;
      box.innerHTML='';
      var jobs = DB.jobs.slice(0);
      jobs.sort(function(a,b){ return new Date(b.createdAt) - new Date(a.createdAt); });
      jobs.slice(0,6).forEach(function(j){
        var c = findCustomer(j.customerId);
        var card = document.createElement('button');
        card.type='button';
        card.className='recent-job-card';
        var custName = c?c.name:'—';
        var created = j.createdAt ? new Date(j.createdAt).toLocaleDateString() : '';
        var status = j.status || 'Open';
        var total = fmt(sumLines(j.lines,'subtotal'));
        card.innerHTML =
          '<div class="recent-job-title">'+custName+'</div>'+
          '<div class="recent-job-meta">'+j.title+'</div>'+
          '<div class="recent-job-meta">'+created+' • '+status+' • '+total+'</div>';
        card.addEventListener('click', function(){
          try{ persistLines(); }catch(_){}
          $('#invJob').value = j.id;
          loadInvoice(j.id);
          UI.lastJobId=j.id;
          saveUI(UI);
          var wrap = $('#recentJobsWrap');
          if(wrap){ wrap.classList.add('collapsed'); }
        });
        box.appendChild(card);
      });
    }

    $('#invCustFilter').addEventListener('change', function(){
      try{ persistLines(); }catch(_){}
      var cur = $('#invJob').value;
      renderInvJobOptions();
      if(!$('#invJob').querySelector('option[value="'+cur+'"]')){
        $('#invJob').value='';
        $('#lines tbody').innerHTML='';
        updatePreview();
        recalcTotals();
      }
    });
    $('#invJobSearch').addEventListener('input', renderInvJobOptions);
    $('#invJob').addEventListener('change', function(){
      try{ persistLines(); }catch(_){}
      var id = this.value;
      if(!id){
        $('#lines tbody').innerHTML='';
        updatePreview();
        recalcTotals();
        return;
      }
      loadInvoice(id);
      UI.lastJobId=id;
      saveUI(UI);
    });

    /* ------ Invoice core ------ */
    function ensureJobSelected(createIfMissing){
      var j = currentJob();
      if(!j && createIfMissing){
        var cust = DB.customers[0];
        if(!cust){
          cust={id:crypto.randomUUID(), name:'Walk-in Customer', phone:'', email:'', vehicle:''};
          DB.customers.push(cust);
          renderCustomers();
        }
        j={
          id:crypto.randomUUID(),
          customerId:cust.id,
          title:'Quick Estimate',
          vin:'',
          notes:'',
          status:'Open',
          lines:[],
          paid:false, paidAt:null,
          docType:'Estimate',
          approved:false, approvedAt:null,
          paymentLink:'',
          vinData:null,
          overallNotes:'',
          internalNotes:'',
          photos:[],
          signatures:{customer:null, manager:null},
          createdAt:new Date().toISOString()
        };
        DB.jobs.push(j);
        saveDB();
        renderJobs();
        renderJobCustomer();
        $('#invJob').value=j.id;
        UI.lastJobId=j.id;
        saveUI(UI);
      }
      if(!j) alert('Pick a job in the "Select job…" dropdown first.');
      return j;
    }

    function currentJob(){
      var id = $('#invJob').value;
      var i;
      for(i=0;i<DB.jobs.length;i++){
        if(DB.jobs[i].id===id) return DB.jobs[i];
      }
      return null;
    }

    function loadInvoice(id){
      var j = currentJob();
      if(!j) j = DB.jobs.filter(function(x){ return x.id===id; })[0];
      if(!j) return;

      j.lines = cleanLines(j.lines || []);

      $('#laborRate').value = (j.laborRate != null) ? j.laborRate : 80;
      $('#salesTax').value  = (j.salesTaxPct != null) ? j.salesTaxPct : 7;

      $('#lines tbody').innerHTML='';
      for(var i=0;i<(j.lines||[]).length;i++){
        var l=j.lines[i];
        // IMPORTANT: skipPersist so we don't overwrite j.lines while building rows
        addLine(l.type,l.desc,l.qty,l.list,l.cost,l.unit,l.note,{skipPersist:true});
      }
      // Single persist after DOM matches full j.lines
      persistLines();

      $('#invNo').value = j.invNo||'';
      $('#docType').value = j.docType||'Estimate';
      $('#payLink').value = j.paymentLink||'';
      var c = findCustomer(j.customerId);
      $('#emailTo').value = (j.emailTo && j.emailTo.trim())
        ? j.emailTo
        : ((c && c.email) ? c.email : '');
      $('#overallNotes').value = j.overallNotes||'';
      $('#internalNotes').value = j.internalNotes||'';
      renderPhotoGrid();
      $('#photosOnPdf').checked = j.photosOnPdf!==false;
      updatePreview();
      recalcTotals();
    }

    function makeRowDraggable(tr){
      var handle = tr.querySelector('.handle');
      if(!handle) return;
      handle.addEventListener('mousedown', function(ev){
        ev.preventDefault();
        var startY = ev.clientY;
        tr.classList.add('dragging');
        function onMove(e){
          var dy = e.clientY - startY;
          tr.style.transform = 'translateY('+dy+'px)';
          var siblings = Array.prototype.slice.call(tr.parentNode.children).filter(function(x){ return x!==tr; });
          var insertBefore = null, i, sib, r, half;
          for(i=0;i<siblings.length;i++){
            sib = siblings[i]; r = sib.getBoundingClientRect(); half = r.top + r.height/2;
            if(e.clientY < half){ insertBefore = sib; break; }
          }
          for(i=0;i<siblings.length;i++){ siblings[i].classList.toggle('drop-target', siblings[i]===insertBefore); }
        }
        function onUp(e){
          tr.classList.remove('dragging');
          tr.style.transform='';
          $all('#lines tbody tr').forEach(function(s){ s.classList.remove('drop-target'); });
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
          var siblings = Array.prototype.slice.call(tr.parentNode.children).filter(function(x){ return x!==tr; });
          var insertBefore = null, i, sib, r, half;
          for(i=0;i<siblings.length;i++){
            sib = siblings[i]; r = sib.getBoundingClientRect(); half = r.top + r.height/2;
            if(e.clientY < half){ insertBefore = sib; break; }
          }
          if(insertBefore){ tr.parentNode.insertBefore(tr, insertBefore); }
          persistLines();
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      });
    }

    // *** addLine now has options, with skipPersist flag ***
    function addLine(type, desc, qty, list, cost, unit, note, options){
      options = options || {};
      var tr = document.createElement('tr');
      var descPH = type==='Labor' ? "e.g., Diagnostics / R&R" : "e.g., Fuel Filter (FF63009) — Fleetguard";
      var qtyPH  = type==='Labor' ? "hrs (e.g., 1.5)"       : "qty (e.g., 1)";
      var listPH = type==='Labor' ? "optional list/MSRP"    : "store list MSRP";
      var costPH = type==='Labor' ? "shop cost (optional)"  : "your cost (e.g., 32.00)";
      var unitPH = type==='Labor' ? "$/hr (auto or manual)" : "customer price";

      tr.className = 'draggable-row';
      tr.innerHTML =
        '<td class="drag-col"><button class="tab-btn handle" title="Drag to reorder">↕</button></td>' +
        '<td><select class="lType"><option '+(type==='Labor'?'selected':'')+'>Labor</option><option '+(type==='Part'?'selected':'')+'>Part</option><option '+(type==='Warranty'?'selected':'')+'>Warranty</option></select></td>' +
        '<td><div class="desc-wrap"><input class="lDesc" value="'+(desc||'')+'" placeholder="'+descPH+'"/><textarea class="lNote" placeholder="Tech note for this line (prints)">'+(note||'')+'</textarea></div></td>' +
        '<td><input class="lQty" type="number" step="0.01" value="'+(qty||1)+'" placeholder="'+qtyPH+'"/></td>' +
        '<td><input class="lList" type="number" step="0.01" value="'+(((list!=null)?list:0))+'" placeholder="'+listPH+'"/></td>' +
        '<td><input class="lCost" type="number" step="0.01" value="'+(((cost!=null)?cost:0))+'" placeholder="'+costPH+'"/></td>' +
        '<td><input class="lUnit" type="number" step="0.01" value="'+(unit||0)+'" placeholder="'+unitPH+'"/><div class="calc-hint">—</div></td>' +
        '<td class="lLine">$0.00</td>' +
        '<td class="lProfit">$0.00</td>' +
        '<td><button type="button" class="tab-btn lDel">X</button></td>';
      document.querySelector('#lines tbody').appendChild(tr);
      makeRowDraggable(tr);
      tr.querySelector('.lDel').addEventListener('click', function(){
        tr.remove();
        persistLines();
      });
      ['change','input'].forEach(function(evt){
        ['.lType','.lDesc','.lQty','.lList','.lCost','.lUnit','.lNote'].forEach(function(sel){
          tr.querySelector(sel).addEventListener(evt, persistLines);
        });
      });
      if (!options.skipPersist) {
        persistLines();
      }
    }

    function rowsToLines(){
      var out = [];
      $all('#lines tbody tr').forEach(function(tr){
        out.push({
          type: tr.querySelector('.lType').value,
          desc: tr.querySelector('.lDesc').value,
          qty:  Number(tr.querySelector('.lQty').value||0),
          list: Number(tr.querySelector('.lList').value||0),
          cost: Number(tr.querySelector('.lCost').value||0),
          unit: Number(tr.querySelector('.lUnit').value||0),
          note: (tr.querySelector('.lNote') ? tr.querySelector('.lNote').value : '').trim()
        });
      });
      return out;
    }

    function persistLines(){
      var j = currentJob();
      if (!j) return;

      // Pull current rows from DOM
      var lines = rowsToLines();

      // Auto-fill Labor and Part unit pricing before saving
      var laborRateNow = Number($('#laborRate').value || 80);
      var factor = Number($('#markupFactor').value || 1.40); // x cost for parts
      var trs = $all('#lines tbody tr');

      for (var i = 0; i < lines.length; i++){
        var ln = lines[i];
        var tr = trs[i];

        // For Labor: if unit is empty/zero, use current labor rate
        if (ln.type === 'Labor' && (!ln.unit || ln.unit === 0)){
          ln.unit = laborRateNow;
          if (tr) {
            var unitElL = tr.querySelector('.lUnit');
            if (unitElL) unitElL.value = laborRateNow.toFixed(2);
          }
        }

        // For Part: if cost is set and unit empty/zero, apply markup factor
        if (ln.type === 'Part' && ln.cost > 0 && (!ln.unit || ln.unit === 0)){
          var newUnit = ln.cost * factor;
          ln.unit = newUnit;
          if (tr) {
            var unitElP = tr.querySelector('.lUnit');
            if (unitElP) unitElP.value = newUnit.toFixed(2);
          }
        }
      }

      // Remove zombie/placeholder rows
      lines = cleanLines(lines);

      // Persist back to the job
      j.lines = lines;
      j.invNo = $('#invNo').value.trim();
      j.docType = $('#docType').value;
      j.paymentLink = $('#payLink').value.trim();
      j.emailTo = $('#emailTo').value.trim();
      j.overallNotes = $('#overallNotes').value || '';
      j.internalNotes = $('#internalNotes').value || '';
      j.photosOnPdf = $('#photosOnPdf').checked;
      j.laborRate = Number($('#laborRate').value || 80);
      j.salesTaxPct = Number($('#salesTax').value || 0);

      // Recalc views
      recalcTotals();
      updatePreview();
      renderJobs();
      renderDashboard();
      saveDB();
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, function(c){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);
      });
    }

    function updatePreview(){
      var j = currentJob();
      document.getElementById('pInvNo').textContent = ($('#invNo').value.trim() || 'DRAFT');
      document.getElementById('pDate').textContent = new Date().toLocaleDateString();
      var t = $('#docType').value;
      var badge = document.getElementById('pType');
      badge.textContent=t;
      badge.className='badge ' + (t==='Invoice'?'invoice':'estimate');
      document.getElementById('pStatus').textContent = j && j.paid
        ? 'Paid'
        : (t==='Estimate' ? (j && j.approved ? 'Approved':'Pending Approval') : 'Unpaid');
      var c = j ? findCustomer(j.customerId) : null;
      document.getElementById('pCust').textContent = c?c.name:'—';
      document.getElementById('pVeh').textContent = c?(c.vehicle||''):'';

      var tbody = document.getElementById('pLines'); tbody.innerHTML='';
      if(j){
        for(var i=0;i<j.lines.length;i++){
          var l=j.lines[i];
          var unit = Number(l.unit || 0);
          var list = Number(l.list || 0);
          var qty  = Number(l.qty  || 0);
          var line = qty * unit;
          var perUnitSave = 0;
          if(list > unit && l.type === 'Part'){
            perUnitSave = list - unit;
          }

          var priceHtml = fmt(unit);
          if(list > 0){
            priceHtml += '<div style="font-size:9pt;font-style:italic;color:#444;">List: '+fmt(list);
            if(perUnitSave > 0){
              priceHtml += ' — Saved '+fmt(perUnitSave)+'/ea';
            }
            priceHtml += '</div>';
          }

          var tr=document.createElement('tr');
          tr.innerHTML=
            '<td>'+l.type+': '+escapeHtml(l.desc||"")+'</td>'+
            '<td>'+qty+'</td>'+
            '<td>'+priceHtml+'</td>'+
            '<td>'+fmt(line)+'</td>';
          tbody.appendChild(tr);

          if(l.note && l.note.trim()){
            var trn=document.createElement('tr');
            trn.innerHTML = '<td colspan="4" style="font-style:italic; color:#333; padding-top:4px;">Note: '+escapeHtml(l.note.trim())+'</td>';
            tbody.appendChild(trn);
          }
        }
      }

      var pBlk = document.getElementById('pOverallBlock'); pBlk.innerHTML='';
      if(j && j.overallNotes && j.overallNotes.trim()){
        pBlk.innerHTML = '<h4 style="margin:8px 0 4px 0;">Technician Overall Notes</h4>' +
          '<div style="white-space:pre-wrap; line-height:1.35;">'+escapeHtml(j.overallNotes.trim())+'</div>';
      }

      function setSig(role){
        var img = role==='customer' ? document.getElementById('pSigCustomer') : document.getElementById('pSigManager');
        var nameEl = role==='customer' ? document.getElementById('pSigCustomerName') : document.getElementById('pSigManagerName');
        var dateEl = role==='customer' ? document.getElementById('pSigCustomerDate') : document.getElementById('pSigManagerDate');
        var data = j && j.signatures ? j.signatures[role] : null;
        if(data && data.dataUrl){
          img.src = data.dataUrl; img.style.display='block';
          nameEl.textContent = data.name ? ('— '+escapeHtml(data.name)) : '';
          dateEl.textContent = data.date ? ('('+data.date+')') : '';
        } else {
          img.src=''; img.style.display='none'; nameEl.textContent=''; dateEl.textContent='';
        }
      }
      setSig('customer');
      setSig('manager');

      var pPhotos = document.getElementById('pPhotosBlock'); pPhotos.innerHTML='';
      if(j && j.photosOnPdf && j.photos && j.photos.length){
        var html = '<h4 style="margin:8px 0 4px 0;">Work Photos</h4><div class="p-photos">';
        for(var pi=0;pi<j.photos.length;pi++){
          var ph=j.photos[pi];
          if(!ph || !ph.dataUrl || ph.include === false) continue;
          html += '<div class="p-photo"><img src="'+ph.dataUrl+'" alt=""></div>';
        }
        html += '</div>';
        pPhotos.innerHTML = html;
      }
    }

    /* ------ Photos grid ------ */
    function renderPhotoGrid(){
      var j=currentJob(); if(!j) return;
      var grid = document.getElementById('photoGrid');
      grid.innerHTML='';
      for(var i=0;i<j.photos.length;i++){
        (function(idx){
          var ph=j.photos[idx];
          var item = document.createElement('div');
          item.className='photo-item';
          item.innerHTML =
            '<img src="'+ph.dataUrl+'" alt=""/>' +
            '<button type="button" class="del">X</button>' +
            '<label><input type="checkbox" '+(ph.include!==false?'checked':'')+'> Include on PDF</label>';
          item.querySelector('.del').addEventListener('click', function(){
            j.photos.splice(idx,1);
            saveDB();
            renderPhotoGrid();
            updatePreview();
          });
          item.querySelector('input[type="checkbox"]').addEventListener('change', function(){
            ph.include = this.checked;
            saveDB();
            updatePreview();
          });
          grid.appendChild(item);
        })(i);
      }
    }

    document.getElementById('photoInput').addEventListener('change', function(){
      var j=currentJob(); if(!j) return;
      var files = this.files || [];
      if(!files.length) return;
      var remaining = files.length;
      for(var i=0;i<files.length;i++){
        (function(file){
          var r = new FileReader();
          r.onload = function(){
            j.photos.push({ dataUrl:r.result, include:true });
            remaining--;
            if(remaining===0){
              saveDB();
              renderPhotoGrid();
              updatePreview();
            }
          };
          r.readAsDataURL(file);
        })(files[i]);
      }
      this.value='';
    });

    document.getElementById('photosOnPdf').addEventListener('change', function(){
      var j=currentJob(); if(!j) return;
      j.photosOnPdf = this.checked;
      saveDB();
      updatePreview();
    });

    /* ------ Quick Estimate modal ------ */
    (function(){
      var modal = document.getElementById('qeModal');
      var open = document.getElementById('quickEstimate');
      var closeBtn = document.getElementById('qeClose');
      var applyAppend = document.getElementById('qeApplyAppend');
      var applyReplace = document.getElementById('qeApplyReplace');

      function close(){ if(modal) modal.style.display='none'; }
      function openModal(){ if(modal) modal.style.display='flex'; }

      if(open){ open.addEventListener('click', openModal); }
      if(closeBtn){ closeBtn.addEventListener('click', close); }

      function buildLines(mode){
        var j = ensureJobSelected(true); if(!j) return;
        var title = (document.getElementById('qeTitle').value||'').trim();
        var partsCost = Number(document.getElementById('qePartsCost').value||0);
        var mu = Number(document.getElementById('qeMarkup').value||40)/100;
        var hours = Number(document.getElementById('qeHours').value||1.5);
        var laborRate = Number(document.getElementById('laborRate').value||80);

        if(mode==='replace'){
          document.querySelector('#lines tbody').innerHTML='';
          j.lines=[];
        }

        addLine('Labor', title?('Diagnose/Repair — '+title):'Diagnose/Repair', hours, 0, 0, laborRate, '', {skipPersist:true});

        if(partsCost>0){
          var sell = partsCost*(1+mu);
          addLine('Part', title?('Parts — '+title):'Parts', 1, 0, partsCost, sell, '', {skipPersist:true});
        }
        persistLines();
        close();
      }

      if(applyAppend){
        applyAppend.addEventListener('click', function(){ buildLines('append'); });
      }
      if(applyReplace){
        applyReplace.addEventListener('click', function(){ buildLines('replace'); });
      }
    })();

    /* ------ Back to Top ------ */
    (function(){
      var btn = document.getElementById('toTop');
      if(!btn) return;
      window.addEventListener('scroll', function(){
        try{ btn.style.display = (window.scrollY > 200 ? 'block' : 'none'); }catch(_){}
      });
      btn.addEventListener('click', function(){
        try{ window.scrollTo({top:0, behavior:'smooth'}); }catch(_){ window.scrollTo(0,0); }
      });
    })();

    /* ------ Settings bindings ------ */
    document.getElementById('defaultMarkup').addEventListener('input', function(){
      DB.settings.defaultMarkup = Number(this.value||40);
      saveDB();
      recalcTotals();
    });
    document.getElementById('shopFrom').addEventListener('input', function(){ DB.settings.shopFrom=this.value; saveDB(); });
    document.getElementById('shopReply').addEventListener('input', function(){ DB.settings.shopReply=this.value; saveDB(); });
    document.getElementById('shopSubj').addEventListener('input', function(){ DB.settings.shopSubj=this.value; saveDB(); });
    document.getElementById('shopFooter').addEventListener('input', function(){ DB.settings.shopFooter=this.value; saveDB(); });

    /* ------ Backup & Restore + Flash-drive FS ------ */
    (function(){
      var EXKEY = STORAGE_KEY;
      var WMKEY = 'pdc_wm_dataurl';

      function downloadText(filename, text){
        var blob = new Blob([text], {type:'application/json'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(function(){ URL.revokeObjectURL(url); }, 500);
      }

      var exportBtn = document.getElementById('exportBtn');
      if(exportBtn){
        exportBtn.addEventListener('click', function(){
          var backup = buildBackupPayload();
          downloadText('poppes_shop_backup_'+Date.now()+'.json', JSON.stringify(backup, null, 2));
        });
      }

      var importBtn = document.getElementById('importBtn');
      var importFile = document.getElementById('importFile');
      if(importBtn && importFile){
        importBtn.addEventListener('click', function(){
          var f = importFile.files && importFile.files[0];
          if(!f){ alert('Choose a backup JSON file first.'); return; }
          var reader = new FileReader();
          reader.onload = function(){
            try{
              var data = JSON.parse(reader.result||'{}');
              var newDB = data.db || data || null;
              if(!newDB || !newDB.customers || !newDB.jobs){
                alert('Invalid backup format.');
                return;
              }
              localStorage.setItem(EXKEY, JSON.stringify(newDB));
              if(data.ui){
                try{ localStorage.setItem(UIKEY, JSON.stringify(data.ui)); }catch(_){}
              }
              if(data.wm){
                try{ localStorage.setItem(WMKEY, data.wm); }catch(_){}
              }
              DB = newDB;
              UI = data.ui || UI;
              upgradeDB();
              renderAll();
              alert('Backup imported. Reloading the UI.');
              location.reload();
            }catch(e){
              alert('Import failed: '+(e.message||e));
            }
          };
          reader.onerror = function(){ alert('Could not read file.'); };
          reader.readAsText(f);
        });
      }

      // File System Access API
      (function(){
        var hasFS = !!(window.showSaveFilePicker && window.FileSystemFileHandle);
        var btnChoose = document.getElementById('fsChoose');
        var btnQuick  = document.getElementById('fsQuickSave');

        if (!hasFS) {
          if (btnChoose) btnChoose.style.display='none';
          if (btnQuick)  btnQuick.style.display='none';
          return;
        }

        var DB_NAME='pdc_fs_store', STORE='kvs';
        function idbOpen(){
          return new Promise(function(res,rej){
            var req=indexedDB.open(DB_NAME,1);
            req.onupgradeneeded=function(){
              var db=req.result;
              if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
            };
            req.onsuccess=function(){res(req.result)};
            req.onerror=function(){rej(req.error)};
          });
        }
        function idbGet(k){
          return idbOpen().then(function(db){
            return new Promise(function(res,rej){
              var tx=db.transaction(STORE,'readonly');
              var st=tx.objectStore(STORE);
              var rq=st.get(k);
              rq.onsuccess=function(){res(rq.result)};
              rq.onerror=function(){rej(rq.error)};
            });
          });
        }
        function idbSet(k,v){
          return idbOpen().then(function(db){
            return new Promise(function(res,rej){
              var tx=db.transaction(STORE,'readwrite');
              var st=tx.objectStore(STORE);
              var rq=st.put(v,k);
              rq.onsuccess=function(){res()};
              rq.onerror=function(){rej(rq.error)};
            });
          });
        }
        function idbDel(k){
          return idbOpen().then(function(db){
            return new Promise(function(res,rej){
              var tx=db.transaction(STORE,'readwrite');
              var st=tx.objectStore(STORE);
              var rq=st.delete(k);
              rq.onsuccess=function(){res()};
              rq.onerror=function(){rej(rq.error)};
            });
          });
        }

        var HANDLE_KEY='pdc_file_handle';
        var fileHandle=null;
        idbGet(HANDLE_KEY).then(function(h){ fileHandle=h||null; }).catch(function(){});

        async function chooseSaveFile(){
          try{
            fileHandle = await window.showSaveFilePicker({
              suggestedName:'poppes_shop_backup.json',
              types:[{ description:'JSON', accept:{'application/json':['.json']} }]
            });
            await idbSet(HANDLE_KEY, fileHandle);
            alert('Save location set. Use "Quick Save" next time.');
          }catch(err){
            if (err && err.name==='AbortError') return;
            alert('Could not set save file: '+(err.message||err));
          }
        }

        async function quickSave(){
          try{
            if (!fileHandle) {
              alert('Pick a save file first (Choose Save File).');
              return;
            }
            var perm = await fileHandle.queryPermission({mode:'readwrite'});
            if (perm!=='granted'){
              perm = await fileHandle.requestPermission({mode:'readwrite'});
              if (perm!=='granted'){
                alert('Permission to write was denied.');
                return;
              }
            }
            var writable = await fileHandle.createWritable();
            var data = JSON.stringify(buildBackupPayload(), null, 2);
            await writable.write(new Blob([data], {type:'application/json'}));
            await writable.close();
            alert('Saved to: ' + (fileHandle.name || 'selected file'));
          }catch(err){
            if (String(err||'').indexOf('No such file')>-1 || String(err||'').indexOf('Permission')>-1) {
              try{ await idbDel(HANDLE_KEY); }catch(_){}
              fileHandle = null;
            }
            alert('Quick Save failed: ' + (err.message || err));
          }
        }

        if (btnChoose) btnChoose.addEventListener('click', chooseSaveFile);
        if (btnQuick)  btnQuick.addEventListener('click', quickSave);
      })();

      /* ---- Supabase Cloud Save/Load buttons ---- */
      var cloudSaveBtn = document.getElementById('cloudSaveBtn');
      var cloudLoadBtn = document.getElementById('cloudLoadBtn');

      async function cloudSave(){
        if (!supabaseClient) {
          alert('Supabase is not configured in this file.');
          return;
        }
        try {
          var payload = buildBackupPayload();
          var totalJobs = (payload.db && payload.db.jobs) ? payload.db.jobs.length : 0;
          var totalLines = 0;
          if (payload.db && payload.db.jobs) {
            for (var i = 0; i < payload.db.jobs.length; i++) {
              var jj = payload.db.jobs[i];
              if (jj.lines && jj.lines.length) totalLines += jj.lines.length;
            }
          }

          var result = await supabaseClient
            .from('shop_state')
            .upsert({
              id: SHOP_STATE_ID,
              data: payload,
              updated_at: new Date().toISOString()
            });

          if (result.error) {
            console.error('cloudSave error', result.error);
            alert('Cloud save failed: ' + result.error.message);
            return;
          }
          alert('Cloud save complete.\nJobs: ' + totalJobs + '\nTotal lines across all jobs: ' + totalLines);
        } catch (e) {
          console.error('cloudSave threw', e);
          alert('Cloud save crashed: ' + (e.message || e));
        }
      }

      async function cloudLoadRaw(){
        if (!supabaseClient) {
          alert('Supabase is not configured in this file.');
          return null;
        }
        try {
          var result = await supabaseClient
            .from('shop_state')
            .select('data')
            .eq('id', SHOP_STATE_ID)
            .single();

          if (result.error) {
            console.error('cloudLoad error', result.error);
            alert('Cloud load failed: ' + result.error.message);
            return null;
          }
          if (!result.data || !result.data.data) {
            alert('No cloud snapshot found yet.');
            return null;
          }
          return result.data.data;
        } catch (e) {
          console.error('cloudLoad threw', e);
          alert('Cloud load crashed: ' + (e.message || e));
          return null;
        }
      }

      if (cloudSaveBtn) {
        cloudSaveBtn.addEventListener('click', async function () {
          try { if (typeof persistLines === 'function') persistLines(); } catch(_){}
          await cloudSave();
        });
      }

      if (cloudLoadBtn) {
        cloudLoadBtn.addEventListener('click', async function () {
          var snap = await cloudLoadRaw();
          if (!snap) return;

          var totalJobs = (snap.db && snap.db.jobs) ? snap.db.jobs.length : 0;
          var totalLines = 0;
          if (snap.db && snap.db.jobs) {
            for (var i = 0; i < snap.db.jobs.length; i++) {
              var jj = snap.db.jobs[i];
              if (jj.lines && jj.lines.length) totalLines += jj.lines.length;
            }
          }
          alert('Cloud loaded.\nJobs in snapshot: ' + totalJobs + '\nTotal lines in snapshot: ' + totalLines);

          if (snap.db) DB = snap.db;
          if (snap.ui) UI = snap.ui;
          try {
            if (snap.wm) localStorage.setItem(WMKEY, snap.wm);
          } catch(_) {}

          upgradeDB();
          renderAll();

          if (UI.lastJobId && DB.jobs.some(function (j) { return j.id === UI.lastJobId; })) {
            document.getElementById('invJob').value = UI.lastJobId;
            loadInvoice(UI.lastJobId);
          } else if (DB.jobs.length) {
            var latest = DB.jobs[0];
            for (var k = 1; k < DB.jobs.length; k++) {
              if ((DB.jobs[k].createdAt || '') > (latest.createdAt || '')) latest = DB.jobs[k];
            }
            document.getElementById('invJob').value = latest.id;
            loadInvoice(latest.id);
            UI.lastJobId = latest.id;
            saveUI(UI);
          }

          alert('Cloud data applied. Check the Invoice tab for your parts + notes.');
        });
      }

    })(); // end backup/restore block

    /* ------ Invoice actions buttons ------ */
    document.getElementById('addLabor').addEventListener('click', function(){
      if(!ensureJobSelected(true)) return;
      addLine('Labor','',1,0,0, Number(document.getElementById('laborRate').value||80), '');
    });
    document.getElementById('addPart').addEventListener('click', function(){
      if(!ensureJobSelected(true)) return;
      addLine('Part','',1,0,0,0,'');
    });
    document.getElementById('applyMarkup').addEventListener('click', applyDefaultMarkup);
    document.getElementById('recalc').addEventListener('click', recalcTotals);

    document.getElementById('markPaid').addEventListener('click', function(){
      var j=ensureJobSelected(); if(!j) return;
      j.paid=!j.paid;
      j.paidAt=j.paid?new Date().toISOString():null;
      if(j.paid){ j.taxPercentAtSale = Number(document.getElementById('salesTax').value||0); }
      updatePreview();
      renderJobs();
      saveDB();
      alert(j.paid?'Marked Paid':'Marked Unpaid');
    });

    document.getElementById('approve').addEventListener('click', function(){
      var j=ensureJobSelected(); if(!j) return;
      if(document.getElementById('docType').value!=='Estimate'){
        alert('Approvals apply to Estimates.');
        return;
      }
      j.approved=true;
      j.approvedAt=new Date().toISOString();
      updatePreview();
      saveDB();
      alert('Estimate approved.');
    });

    document.getElementById('convert').addEventListener('click', function(){
      var j=ensureJobSelected(); if(!j) return;
      j.docType='Invoice';
      document.getElementById('docType').value='Invoice';
      updatePreview();
      saveDB();
      alert('Converted to Invoice.');
    });

    document.getElementById('email').addEventListener('click', function(){
      var j=ensureJobSelected(); if(!j) return;
      var to=encodeURIComponent(document.getElementById('emailTo').value.trim()||'');
      var subj=encodeURIComponent((DB.settings.shopSubj||'') + (j.docType+' '+(j.invNo||'')+' from '+(DB.settings.shopFrom||'Your Shop')).trim());
      var body=encodeURIComponent(
        'Hello,\n\nYour '+j.docType+' total is '+document.getElementById('grand').textContent+
        '.\nPayment link: '+(j.paymentLink||'')+
        '\n\n'+(DB.settings.shopFooter||'')+
        '\n\n— '+(DB.settings.shopFrom||'')
      );
      location.href='mailto:'+to+'?subject='+subj+'&body='+body;
    });

    /* ------ PDF (print) ------ */
    document.getElementById('pdf').addEventListener('click', function(){
      var css =
        'html,body{margin:0;padding:0}body{font-family:'+ (document.body && getComputedStyle(document.body).fontFamily || 'sans-serif') +';font-size:11pt;line-height:1.35;color:#000}'+
        '.print-area{padding:8px 12px 12px;border-radius:0;position:relative}'+
        '.invoice-header{display:flex;justify-content:space-between;gap:12px;border-bottom:1px solid #000;padding-bottom:4px;margin-bottom:6px}'+
        '.invoice-header h3{margin:0;font-size:14pt}'+
        'table{width:100%;border-collapse:collapse;margin-top:6px}'+
        'th,td{border-bottom:1px solid #000;padding:6px;text-align:left;vertical-align:top;font-size:10pt}'+
        '.totals{display:grid;gap:4px;justify-items:end;margin-top:8px}.grand{font-weight:700}'+
        '.badge{border:1px solid #000;border-radius:9999px;padding:2px 6px;font-size:9pt}'+
        '.signatures{margin-top:16px;display:grid;gap:10px}'+
        '.sig-row{display:grid;grid-template-columns:2fr 1fr;gap:16px;align-items:end}'+
        '.sig-line{border-bottom:1px solid #000;height:28px;display:flex;align-items:flex-end}'+
        '.sig-label{font-size:9pt;color:#333;margin-top:4px}'+
        '.sig-img{max-height:60px;}'+
        '.watermark{position:absolute;inset:0;z-index:0;opacity:.28}'+
        '#wmImg{max-width:90%;max-height:90%;opacity:.28}'+
        '#wmFallback{opacity:.28}'+
        '.p-photos{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:6px}'+
        '.p-photo{border:1px solid #000;padding:4px;border-radius:6px;break-inside:avoid;page-break-inside:avoid}'+
        '.p-photo img{width:100%;height:1.8in;object-fit:cover;border-radius:4px;display:block}'+
        '#pPhotosBlock{page-break-before:always}';
      var htmlDoc = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Invoice/Estimate</title><style>'+css+'</style></head><body>' +
                    document.getElementById('preview').outerHTML +
                    '</body></html>';
      var w = window.open('', '_blank');
      if(!w){
        alert('Please allow pop-ups to print.');
        return;
      }
      w.document.open();
      w.document.write(htmlDoc);
      w.document.close();
      try{ w.focus(); w.print(); }catch(_){}
    });

    /* ------ Signature modal ------ */
    (function(){
      var modal = document.getElementById('sigModal');
      var openBtn = document.getElementById('sign');
      var closeBtn = document.getElementById('sigClose');
      var saveBtn = document.getElementById('sigSave');
      var clearBtn = document.getElementById('sigClear');
      var pad = document.getElementById('sigPad');
      if(!modal || !openBtn || !pad) return;
      var ctx = pad.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,pad.width,pad.height);
      var drawing=false, lastX=0,lastY=0;
      function startDraw(x,y){ drawing=true; lastX=x; lastY=y; }
      function moveDraw(x,y){
        if(!drawing) return;
        ctx.strokeStyle='#000';
        ctx.lineWidth=2;
        ctx.lineCap='round';
        ctx.beginPath();
        ctx.moveTo(lastX,lastY);
        ctx.lineTo(x,y);
        ctx.stroke();
        lastX=x; lastY=y;
      }
      function endDraw(){ drawing=false; }

      pad.addEventListener('mousedown', function(e){
        var r=pad.getBoundingClientRect();
        startDraw(e.clientX-r.left,e.clientY-r.top);
      });
      pad.addEventListener('mousemove', function(e){
        var r=pad.getBoundingClientRect();
        moveDraw(e.clientX-r.left,e.clientY-r.top);
      });
      pad.addEventListener('mouseup', endDraw);
      pad.addEventListener('mouseleave', endDraw);
      pad.addEventListener('touchstart', function(e){
        e.preventDefault();
        var t=e.touches[0], r=pad.getBoundingClientRect();
        startDraw(t.clientX-r.left,t.clientY-r.top);
      }, {passive:false});
      pad.addEventListener('touchmove', function(e){
        e.preventDefault();
        var t=e.touches[0], r=pad.getBoundingClientRect();
        moveDraw(t.clientX-r.left,t.clientY-r.top);
      }, {passive:false});
      pad.addEventListener('touchend', function(e){
        e.preventDefault();
        endDraw();
      }, {passive:false});

      function open(){ modal.style.display='flex'; }
      function close(){ modal.style.display='none'; }

      openBtn.addEventListener('click', function(){
        if(!ensureJobSelected()) return;
        open();
      });
      closeBtn.addEventListener('click', close);
      clearBtn.addEventListener('click', function(){
        ctx.fillStyle='#fff';
        ctx.fillRect(0,0,pad.width,pad.height);
      });
      saveBtn.addEventListener('click', function(){
        var j=currentJob(); if(!j) return;
        var role=document.getElementById('sigRole').value;
        var name=document.getElementById('sigName').value.trim();
        var date=document.getElementById('sigDate').value;
        var dataUrl = pad.toDataURL('image/png');
        if(!j.signatures) j.signatures={customer:null, manager:null};
        j.signatures[role]={name:name, date:date, dataUrl:dataUrl};
        saveDB();
        updatePreview();
        close();
      });
    })();

    /* ------ Recent jobs dropdown toggle ------ */
    (function(){
      var toggle = document.getElementById('recentJobsToggle');
      var wrap = document.getElementById('recentJobsWrap');
      if(!toggle || !wrap) return;
      toggle.addEventListener('click', function(){
        wrap.classList.toggle('collapsed');
      });
    })();

    /* ------ Keep overall notes synced ------ */
    (function(){
      var on = document.getElementById('overallNotes');
      if(on){
        on.addEventListener('input', function(){
          persistLines();
        });
      }
    })();


    /* ------ Markup factor + auto-calc overrides (12/09/2025) ------ */

    function getMarkupFactor(){
      var el = document.getElementById('markupFactor');
      var v = el ? Number(el.value || 0) : 0;
      if (!isFinite(v) || v <= 0){
        if (typeof DB !== 'undefined' && DB && DB.settings && typeof DB.settings.defaultMarkup === 'number'){
          v = 1 + (DB.settings.defaultMarkup/100);
        } else {
          v = 1.4; // sensible default
        }
      }
      return v;
    }

    function applyDefaultMarkup(){
      var factor = getMarkupFactor(); // e.g. 1.40 for 40% over cost
      var mu = factor - 1;            // markup as fraction
      $all('#lines tbody tr').forEach(function(tr){
        var typeSel = tr.querySelector('.lType');
        if (!typeSel || typeSel.value !== 'Part') return;
        var cost = Number(tr.querySelector('.lCost').value || 0);
        var newUnit = cost * factor;
        if (newUnit > 0){
          var unitEl = tr.querySelector('.lUnit');
          if (unitEl) unitEl.value = newUnit.toFixed(2);
        }
      });
      persistLines();
    }

    function setupCostAutoCalc(){
      var tbody = document.querySelector('#lines tbody');
      if (!tbody) return;
      tbody.addEventListener('input', function(ev){
        var target = ev.target;
        if (!target.classList.contains('lCost')) return;
        var tr = target.closest('tr');
        if (!tr) return;
        var typeSel = tr.querySelector('.lType');
        if (typeSel && typeSel.value !== 'Part') return; // only auto-calc parts
        var cost = Number(target.value || 0);
        var factor = getMarkupFactor();
        var unitEl = tr.querySelector('.lUnit');
        if (!unitEl) return;
        var newUnit = cost * factor;
        if (newUnit > 0){
          unitEl.value = newUnit.toFixed(2);
        } else {
          unitEl.value = '';
        }
        persistLines();
      });
    }

    function recalcTotals(){
      var rows = rowsToLines();
      var subtotal = 0, profit = 0, partsSubtotal = 0, savingsTotal = 0;
      var laborRate = Number($('#laborRate').value || 80);
      var muDefault = getMarkupFactor() - 1; // compare against current factor
      var trs = $all('#lines tbody tr');
      var warrantyHours = 0;

      for (var i = 0; i < rows.length; i++){
        var r = rows[i];
        var isWarranty = (r.type === 'Warranty');

        // If labor line with no unit, default to laborRate and sync UI
        if (r.type === 'Labor' && (!r.unit || r.unit === 0)) {
          r.unit = laborRate;
          if (trs[i]) {
            var uEl = trs[i].querySelector('.lUnit');
            if (uEl) uEl.value = r.unit.toFixed(2);
          }
        }

        if (isWarranty) {
          warrantyHours += (r.qty || 0);
        }

        var lineTotal = isWarranty ? 0 : (r.qty * r.unit);
        if (!isWarranty) {
          subtotal += lineTotal;
        }

        if (r.type === 'Part' && !isWarranty) {
          partsSubtotal += lineTotal;
          var list = Number(r.list || 0);
          if (list > r.unit) {
            savingsTotal += (list - r.unit) * (r.qty || 1);
          }
        }

        var lineProfit = isWarranty ? 0 : (r.qty * (r.unit - (r.cost || 0)));
        r.profit = lineProfit;
        if (!isWarranty) {
          profit += lineProfit;
        }

        var tr = trs[i];
        if (!tr) continue;
        var lineCell = tr.querySelector('.lLine');
        if (lineCell) lineCell.textContent = fmt(lineTotal);
        var profitCell = tr.querySelector('.lProfit');
        if (profitCell) profitCell.textContent = fmt(lineProfit);

        var hint = tr.querySelector('.calc-hint');
        if (hint){
          if (isWarranty) {
            hint.className = 'calc-hint ok';
            hint.textContent = 'Warranty hours (not billed)';
          } else {
            var up = (r.unit - (r.cost || 0));
            var per = (r.cost > 0) ? Math.round((up / r.cost) * 100) : 100;
            var cls = (r.cost > 0 && (up / r.cost) >= muDefault) ? 'ok' : (r.cost > 0 ? 'warn' : 'ok');
            // dollars of profit for this line
            var dollars = fmt(up * (r.qty || 1));
            var perTxt = r.cost > 0 ? '(+' + per + '%)' : '(set cost for %)';
            hint.className = 'calc-hint ' + cls;
            hint.textContent = dollars + ' ' + perTxt;
          }
        }
      }

      var taxPct = Number($('#salesTax').value || 0);
      var tax = partsSubtotal * (taxPct / 100); // parts-only tax
      var grand = subtotal + tax;

      document.getElementById('sub').textContent = fmt(subtotal);
      document.getElementById('tax').textContent = fmt(tax);
      document.getElementById('grand').textContent = fmt(grand);
      document.getElementById('profit').textContent = fmt(profit);
      document.getElementById('save').textContent = fmt(savingsTotal);

      var margin = grand > 0 ? Math.round((profit / grand) * 100) : 0;
      var badge = document.getElementById('margin');
      if (badge){
        badge.textContent = margin + '%';
        badge.className = 'badge ' + (margin >= 25 ? 'invoice' : (margin >= 15 ? 'badge-open' : 'estimate'));
      }

      var wEl = document.getElementById('wHours');
      if (wEl) wEl.textContent = warrantyHours.toFixed(2);

      var pwEl = document.getElementById('pWHours');
      if (pwEl) pwEl.textContent = warrantyHours.toFixed(2);

      document.getElementById('pSub').textContent = fmt(subtotal);
      document.getElementById('pTax').textContent = fmt(tax);
      document.getElementById('pGrand').textContent = fmt(grand);
      document.getElementById('pSave').textContent = fmt(savingsTotal);
    }

    // Initialize markup field + auto-calc once DOM is ready (inside init guard)
    (function initMarkupAndAutoCalc(){
      var el = document.getElementById('markupFactor');
      if (el){
        // Try restore from UI cache if present
        if (typeof UI !== 'undefined' && UI && UI.markupFactor != null){
          el.value = UI.markupFactor;
        } else if (typeof DB !== 'undefined' && DB && DB.settings && typeof DB.settings.defaultMarkup === 'number'){
          var pct = DB.settings.defaultMarkup; // e.g. 40
          el.value = (1 + pct/100).toFixed(2);
        }
        el.addEventListener('input', function(){
          if (typeof UI !== 'undefined' && UI){
            UI.markupFactor = el.value;
            saveUI(UI);
          }
          recalcTotals();
        });
      }
      setupCostAutoCalc();
    })();

    /* ------ Self-test badge ------ */
    (function selftest(){
      var ok = !!(window.localStorage && document.querySelector && document.createElement);
      var tag=document.getElementById('selftest');
      if(tag){
        tag.textContent='Self-test: '+(ok?'OK':'Limited');
        tag.className='tag selftest '+(ok?'ok':'warn');
      }
    })();

    /* ------ Initial upgrade + render ------ */
    upgradeDB();
    renderAll();

    // Restore last opened job
    if (UI.lastJobId && DB.jobs.some(function(x){return x.id===UI.lastJobId;})) {
      $('#invJob').value = UI.lastJobId;
      loadInvoice(UI.lastJobId);
    }

  }); // end guard init
});
</script>

</body>
</html>

