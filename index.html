<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Poppe‚Äôs Diesel Co. ‚Äî Invoice</title>
<style>
  /* =========================
     THEME ‚Äî tweak these only
     ========================= */
  :root{
    --brand-name: "Poppe‚Äôs 1776 Diesel Co.";
    /* Core brand tones (tuned for print contrast) */
    --color-primary: #0a3d2e;     /* deep diesel green */
    --color-secondary: #b22222;   /* shop red accent */
    --color-accent: #f5c518;      /* high-contrast badge */
    --color-ink: #111111;         /* body text */
    --color-subtle: #555;
    --color-muted: #8b8b8b;
    --color-bg: #f8faf9;
    --color-card: #ffffff;
    --color-line: #e6e6e6;

    /* Buttons */
    --btn-bg: var(--color-primary);
    --btn-ink: #ffffff;
    --btn-bg-alt: #ffffff;
    --btn-ink-alt: var(--color-primary);
    --btn-border-alt: var(--color-primary);

    /* Typography + sizing */
    --font: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    --radius: 16px;
    --radius-sm: 10px;
    --shadow: 0 6px 30px rgba(0,0,0,.08);

    /* Watermark */
    --wm-opacity: 0.15; /* ~85% transparent */
    --wm-size: 80vmin;  /* watermark scale */
  }

  /* Reset-ish */
  *,*::before,*::after{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family:var(--font);
    color:var(--color-ink);
    background:linear-gradient(180deg, #f4f7f5, #eef3f0 30%, #edf2ef 100%);
  }

  .app{
    max-width:1100px;
    margin:24px auto 96px;
    padding:0 16px;
  }

  .toolbar{
    position:sticky; top:0; z-index:5;
    background:rgba(255,255,255,.8);
    backdrop-filter: blur(6px);
    border:1px solid var(--color-line);
    border-top:0;
    border-radius:0 0 var(--radius) var(--radius);
    margin:0 auto 16px;
    padding:10px;
    display:flex; gap:8px; flex-wrap:wrap;
    box-shadow: 0 8px 24px rgba(0,0,0,.06);
  }
  .btn{
    border:none;
    background:var(--btn-bg);
    color:var(--btn-ink);
    padding:10px 14px;
    border-radius:999px;
    font-weight:600;
    cursor:pointer;
    transition:transform .04s ease, box-shadow .15s ease, opacity .2s ease;
    box-shadow:0 4px 14px rgba(0,0,0,.12);
    user-select:none;
  }
  .btn:hover{ transform:translateY(-1px); }
  .btn:active{ transform:translateY(0); }
  .btn-outline{
    background:var(--btn-bg-alt);
    color:var(--btn-ink-alt);
    border:2px solid var(--btn-border-alt);
    box-shadow:none;
  }
  .btn-danger{
    background:#1a1a1a; color:#fff;
    border:2px solid #1a1a1a;
  }
  .btn-chip{
    background:#fff; color:var(--color-ink);
    border:1px dashed var(--color-line);
    box-shadow:none; border-radius:12px;
    padding:8px 10px;
  }
  input[type="file"]{ display:none; }

  /* Invoice card (print area) */
  .sheet{
    position:relative;
    background:var(--color-card);
    border:1px solid var(--color-line);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  /* Watermark */
  .sheet[data-watermark="on"]::after{
    content:"";
    position:absolute; inset:0;
    background-repeat:no-repeat;
    background-position:center;
    background-size:var(--wm-size) auto;
    opacity:var(--wm-opacity);
    pointer-events:none;
    z-index:0;
  }

  .sheet-inner{
    position:relative;
    z-index:1;
    padding:28px;
    display:grid;
    grid-template-columns: 1.2fr 0.8fr;
    gap:22px;
  }

  .brand{
    display:flex; align-items:center; gap:16px;
  }
  .brand-logo{
    width:68px; height:68px; border-radius:14px;
    border:2px solid var(--color-line);
    object-fit:contain; background:#fff;
  }
  .brand h1{
    margin:0;
    font-size:24px; line-height:1.1;
    letter-spacing:.2px;
  }
  .brand small{
    color:var(--color-subtle);
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:1px;
  }

  .tag{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--color-line);
    background: #fff;
    font-size:12px; font-weight:700;
  }
  .paid{ background: #19a14a10; color:#167a3a; border-color:#167a3a33; }
  .unpaid{ background: #b2222210; color:#8c1919; border-color:#8c191933; }

  .section{
    border:1px dashed var(--color-line);
    border-radius:14px;
    padding:14px;
    background:#fff;
  }
  .section h3{
    margin:0 0 10px;
    font-size:14px; text-transform:uppercase;
    letter-spacing:.8px; color:var(--color-primary);
  }

  .grid-2{
    display:grid; grid-template-columns: 1fr 1fr; gap:12px;
  }
  .field{
    display:flex; flex-direction:column; gap:6px;
  }
  label{ font-size:12px; color:var(--color-subtle); font-weight:600; }
  input, textarea, select{
    width:100%;
    padding:10px 12px;
    border:1px solid var(--color-line);
    border-radius:10px;
    font:inherit;
    background:#fff;
  }
  textarea{ min-height:84px; resize:vertical; }

  table{
    width:100%; border-collapse:collapse; overflow:hidden;
    border-radius:12px; border:1px solid var(--color-line);
  }
  thead th{
    text-align:left; font-size:12px; color:#444;
    background: linear-gradient(180deg, #f7faf8, #f2f6f3);
    padding:10px;
    border-bottom:1px solid var(--color-line);
  }
  tbody td{
    padding:8px 10px; border-bottom:1px solid #efefef;
  }
  tbody tr:last-child td{ border-bottom:none; }
  tbody input{
    width:100%; border:1px solid #ececec; background:#fff;
    border-radius:8px; padding:8px;
  }
  .tbl-actions{
    display:flex; gap:6px; justify-content:flex-end;
  }

  .totals{
    display:grid; grid-template-columns: 1fr minmax(260px, 320px);
    gap:18px; align-items:start;
  }
  .box{
    border:1px solid var(--color-line);
    border-radius:14px; padding:14px; background:#fff;
  }
  .rows{ display:grid; gap:8px; }
  .rows .row{
    display:flex; justify-content:space-between; align-items:center;
    gap:12px; border-bottom:1px dashed #eee; padding:6px 0;
  }
  .rows .row:last-child{ border-bottom:none; }
  .money{ font-variant-numeric: tabular-nums; font-weight:700; }

  .badge{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    font-size:12px; font-weight:800;
    background: var(--color-accent);
    color: #111; /* dark text for max contrast on yellow */
    border:1px solid rgba(0,0,0,.1);
  }

  .foot{
    display:flex; justify-content:space-between; align-items:center; gap:12px;
    padding:16px 22px; border-top:1px solid var(--color-line);
    background:linear-gradient(180deg,#fafcfa,#f6faf7);
  }
  .foot small{ color:var(--color-muted); }
  .brandline{
    height:4px; background:linear-gradient(90deg, var(--color-secondary), var(--color-primary));
  }

  /* Hide UI in print */
  @media print{
    body{ background:#fff; }
    .toolbar{ display:none !important; }
    .app{ margin:0; padding:0; }
    .sheet{ border:none; box-shadow:none; border-radius:0; }
    .sheet-inner{ padding:18mm; }
    .btn{ display:none !important; }
    input, textarea, select{ border-color:#ddd; }
    .brand-logo{ border-color:#ddd; }
  }
</style>
</head>
<body>
  <div class="app">
    <div class="toolbar">
      <button class="btn" id="btnPrint" title="Open print dialog">üñ®Ô∏è Print / Save PDF</button>
      <button class="btn-outline btn" id="btnAddRow">Ôºã Add Line</button>
      <button class="btn-outline btn" id="btnAddLabor">üîß Add Labor Row</button>
      <button class="btn-outline btn" id="btnTogglePaid">üí≥ Toggle Paid</button>
      <button class="btn-outline btn" id="btnClear">üßπ Clear</button>
      <button class="btn-danger btn" id="btnArchive">üóÉÔ∏è Archive</button>

      <label class="btn-chip" for="logoInput">üì∑ Upload Logo</label>
      <input id="logoInput" type="file" accept="image/*" />
      <button class="btn-chip" id="btnWatermark">üñºÔ∏è Watermark: <span id="wmState">On</span></button>
      <button class="btn-chip" id="btnTheme">üé® Theme Vars</button>
    </div>

    <div class="sheet" id="sheet" data-watermark="on">
      <div class="brandline"></div>
      <div class="sheet-inner">
        <div>
          <div class="brand">
            <img id="brandLogo" class="brand-logo" alt="Logo" />
            <div>
              <h1 id="brandName">Poppe‚Äôs Diesel Co.</h1>
              <small>Invoice &nbsp;‚Ä¢&nbsp; Columbus, IN</small>
            </div>
          </div>

          <div class="section" style="margin-top:14px">
            <div class="grid-2">
              <div class="field">
                <label>Bill To</label>
                <textarea id="billTo" placeholder="Name&#10;Phone / Email&#10;Address"></textarea>
              </div>
              <div class="field">
                <label>Vehicle / Notes</label>
                <textarea id="vehicle" placeholder="Year Make Model VIN&#10;Odometer / Plate&#10;Notes"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="section">
            <div class="grid-2">
              <div class="field">
                <label>Invoice #</label>
                <input id="invNum" />
              </div>
              <div class="field">
                <label>Date</label>
                <input id="invDate" type="date" />
              </div>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <span id="statusTag" class="tag unpaid">‚óè Unpaid</span>
              <span class="tag">Margin <span id="marginBadge" class="badge">‚Äî</span></span>
            </div>
          </div>
        </div>

        <div class="section" style="grid-column:1 / -1">
          <table id="lines">
            <thead>
              <tr>
                <th style="width:40%">Description</th>
                <th style="width:12%">Qty/Hrs</th>
                <th style="width:14%">Rate ($)</th>
                <th style="width:14%">Cost ($)</th>
                <th style="width:14%">Line Total ($)</th>
                <th style="width:6%"></th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="totals" style="grid-column:1 / -1">
          <div class="box">
            <div class="grid-2">
              <div class="field">
                <label>Parts Cost (your cost)</label>
                <input id="partsCost" type="number" step="0.01" value="0">
              </div>
              <div class="field">
                <label>Sales Tax %</label>
                <input id="taxRate" type="number" step="0.01" value="7">
              </div>
            </div>
            <div class="field" style="margin-top:10px;">
              <label>Terms / Footer Note</label>
              <textarea id="footer" placeholder="Thanks for your business! 30-day warranty on parts."></textarea>
            </div>
          </div>

          <div class="box">
            <div class="rows">
              <div class="row"><span>Subtotal</span><span class="money" id="subtotal">$0.00</span></div>
              <div class="row"><span>Tax</span><span class="money" id="tax">$0.00</span></div>
              <div class="row"><span>Parts + Labor Cost (internal)</span><span class="money" id="cost">$0.00</span></div>
              <div class="row"><span>Margin</span><span class="money" id="margin">$0.00</span></div>
              <div class="row" style="font-size:19px;"><strong>Total</strong><strong class="money" id="total">$0.00</strong></div>
            </div>
          </div>
        </div>
      </div>

      <div class="foot">
        <small id="brandFoot">Poppe‚Äôs Diesel Co. ‚Ä¢ Honest work, fair price.</small>
        <small id="invHint">Use the Print button to Save as PDF. Logo watermark is preserved.</small>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const fmt = n => (isFinite(n) ? n : 0);
  const money = n => fmt(n).toLocaleString(undefined, {style:'currency', currency:'USD'});

  const tbody = $("#tbody");
  const partsCost = $("#partsCost");
  const taxRate = $("#taxRate");
  const subtotalEl = $("#subtotal");
  const taxEl = $("#tax");
  const costEl = $("#cost");
  const marginEl = $("#margin");
  const totalEl = $("#total");
  const marginBadge = $("#marginBadge");

  /* ====== Theme Vars Dialog ====== */
  $("#btnTheme").addEventListener("click", () => {
    const cur = {
      primary: getComputedStyle(document.documentElement).getPropertyValue("--color-primary").trim(),
      secondary: getComputedStyle(document.documentElement).getPropertyValue("--color-secondary").trim(),
      accent: getComputedStyle(document.documentElement).getPropertyValue("--color-accent").trim(),
      wm: getComputedStyle(document.documentElement).getPropertyValue("--wm-opacity").trim()
    };
    const ans = prompt(
`Edit theme (comma separated):
PRIMARY, SECONDARY, ACCENT, WATERMARK_OPACITY
Current:
${cur.primary}, ${cur.secondary}, ${cur.accent}, ${cur.wm}

Example:
#0a3d2e, #b22222, #f5c518, 0.15
`, `${cur.primary}, ${cur.secondary}, ${cur.accent}, ${cur.wm}`);
    if(!ans) return;
    const parts = ans.split(",").map(s=>s.trim());
    if(parts.length>=3){
      document.documentElement.style.setProperty("--color-primary", parts[0]);
      document.documentElement.style.setProperty("--color-secondary", parts[1]);
      document.documentElement.style.setProperty("--color-accent", parts[2]);
      if(parts[3]) document.documentElement.style.setProperty("--wm-opacity", parts[3]);
      persist();
      alert("Theme updated. (Saved)");
    }
  });

  /* ====== Watermark controls ====== */
  const sheet = $("#sheet");
  const wmState = $("#wmState");
  $("#btnWatermark").addEventListener("click", () => {
    const on = sheet.getAttribute("data-watermark") === "on";
    sheet.setAttribute("data-watermark", on ? "off" : "on");
    wmState.textContent = on ? "Off" : "On";
    persist();
  });

  /* ====== Logo upload (header + watermark) ====== */
  const logoInput = $("#logoInput");
  const brandLogo = $("#brandLogo");
  logoInput.addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    const data = await fileToDataURL(file);
    brandLogo.src = data;
    setWatermark(data);
    localStorage.setItem("pdc_logo", data);
  });

  function setWatermark(dataUrl){
    sheet.style.setProperty("--wm-image", `url("${dataUrl}")`);
    sheet.style.setProperty("--wm-opacity", getComputedStyle(document.documentElement).getPropertyValue("--wm-opacity") || "0.15");
    sheet.style.backgroundImage = "none";
    // Pseudo-element uses background via inline style on ::after
    sheet.style.setProperty("--wm-size", "80vmin");
    sheet.style.setProperty("--wm-opacity", getComputedStyle(document.documentElement).getPropertyValue("--wm-opacity").trim() || "0.15");
    sheet.style.setProperty("--wm-image", `url("${dataUrl}")`);
    // Apply via stylesheet override
    sheet.setAttribute("data-has-wm", "1");
    sheet.style.setProperty("--wm-opacity", getComputedStyle(document.documentElement).getPropertyValue("--wm-opacity"));
    // Inject background on ::after by setting inline style:
    sheet.style.setProperty("--after-bg", `url("${dataUrl}")`);
    sheet.style.setProperty("--wm-size", "80vmin");
    // Fallback: set via style attribute
    sheet.style.setProperty("--wm", dataUrl);
    sheet.style.setProperty("--wm-size", "80vmin");
    sheet.style.setProperty("--wm-opacity", "0.15");
    // Real application: set background on ::after with JS by appending a style tag:
    ensureWatermarkCSS(dataUrl);
  }

  function ensureWatermarkCSS(dataUrl){
    let tag = document.getElementById("wm-style");
    if(!tag){
      tag = document.createElement("style");
      tag.id = "wm-style";
      document.head.appendChild(tag);
    }
    tag.textContent = `
      #sheet[data-watermark="on"]::after{
        background-image: url("${dataUrl}");
      }
    `;
  }

  function fileToDataURL(file){
    return new Promise((res,rej)=>{
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(file);
    });
  }

  /* ====== Lines ====== */
  function addRow({desc="", qty=1, rate=0, cost=0}={}){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input class="desc" placeholder="Part / Labor description" value="${esc(desc)}"/></td>
      <td><input class="qty" type="number" step="0.01" value="${qty}"/></td>
      <td><input class="rate" type="number" step="0.01" value="${rate}"/></td>
      <td><input class="cost" type="number" step="0.01" value="${cost}"/></td>
      <td class="money lineTotal">$0.00</td>
      <td class="tbl-actions">
        <button class="btn-outline btn btn-mini">‚úñ</button>
      </td>
    `;
    tbody.appendChild(tr);
    tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", recalc));
    tr.querySelector(".btn-mini").addEventListener("click", ()=>{ tr.remove(); recalc(); persist(); });
    recalc();
    persist();
  }

  function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

  $("#btnAddRow").addEventListener("click", ()=> addRow({}));
  $("#btnAddLabor").addEventListener("click", ()=>{
    addRow({desc:"Labor", qty:1, rate:95, cost:0});
  });

  /* ====== Paid Toggle ====== */
  const statusTag = $("#statusTag");
  $("#btnTogglePaid").addEventListener("click", ()=>{
    const paid = statusTag.classList.toggle("paid");
    statusTag.classList.toggle("unpaid", !paid);
    statusTag.textContent = paid ? "‚óè Paid" : "‚óè Unpaid";
    persist();
  });

  /* ====== Print ====== */
  $("#btnPrint").addEventListener("click", ()=>{
    window.print(); // keeps the native dialog so you can choose printer or "Save as PDF"
  });

  /* ====== Clear ====== */
  $("#btnClear").addEventListener("click", ()=>{
    if(!confirm("Clear all fields?")) return;
    localStorage.removeItem("pdc_invoice_state");
    localStorage.removeItem("pdc_logo");
    location.reload();
  });

  /* ====== Archive (local) ====== */
  $("#btnArchive").addEventListener("click", ()=>{
    const record = snapshot();
    const key = "pdc_archive";
    const all = JSON.parse(localStorage.getItem(key) || "[]");
    all.unshift({ savedAt: new Date().toISOString(), ...record });
    localStorage.setItem(key, JSON.stringify(all));
    alert("Archived locally. (You can export localStorage later if needed.)");
  });

  /* ====== Recalc totals ====== */
  [partsCost, taxRate].forEach(el => el.addEventListener("input", ()=>{ recalc(); persist(); }));
  $("#billTo").addEventListener("input", persist);
  $("#vehicle").addEventListener("input", persist);
  $("#footer").addEventListener("input", persist);
  $("#invNum").addEventListener("input", persist);
  $("#invDate").addEventListener("input", persist);

  function recalc(){
    let subtotal = 0;
    let internalCost = parseFloat(partsCost.value || 0);

    $$("#tbody tr").forEach(tr=>{
      const qty  = parseFloat(tr.querySelector(".qty").value || 0);
      const rate = parseFloat(tr.querySelector(".rate").value || 0);
      const cost = parseFloat(tr.querySelector(".cost").value || 0);

      const line = qty * rate;
      subtotal += line;
      internalCost += cost;

      tr.querySelector(".lineTotal").textContent = money(line);
    });

    const tax = subtotal * (parseFloat(taxRate.value || 0) / 100);
    const total = subtotal + tax;
    const margin = total - internalCost;
    const marginPct = total > 0 ? (margin / total) * 100 : 0;

    subtotalEl.textContent = money(subtotal);
    taxEl.textContent = money(tax);
    totalEl.textContent = money(total);
    costEl.textContent = money(internalCost);
    marginEl.textContent = money(margin);

    updateMarginBadge(marginPct);
  }

  function updateMarginBadge(pct){
    const val = isFinite(pct) ? pct : 0;
    const text = `${val.toFixed(1)}%`;
    marginBadge.textContent = text;

    // Contrast logic: under 15% -> red-ish border cue, 15‚Äì35% -> normal, >35% -> subtle green ring
    if(val < 15){
      marginBadge.style.background = "#ffd7d7";
      marginBadge.style.color = "#640d0d";
      marginBadge.style.borderColor = "#640d0d33";
      marginBadge.style.fontWeight = "900";
    }else if(val > 35){
      marginBadge.style.background = "#e6ffe6";
      marginBadge.style.color = "#0f5d1f";
      marginBadge.style.borderColor = "#0f5d1f33";
      marginBadge.style.fontWeight = "800";
    }else{
      marginBadge.style.background = getComputedStyle(document.documentElement).getPropertyValue("--color-accent").trim() || "#f5c518";
      marginBadge.style.color = "#111";
      marginBadge.style.borderColor = "rgba(0,0,0,.1)";
      marginBadge.style.fontWeight = "800";
    }
  }

  /* ====== Persistence ====== */
  function snapshot(){
    const lines = $$("#tbody tr").map(tr=>({
      desc: tr.querySelector(".desc").value,
      qty: tr.querySelector(".qty").value,
      rate: tr.querySelector(".rate").value,
      cost: tr.querySelector(".cost").value
    }));
    const paid = $("#statusTag").classList.contains("paid");
    return {
      invNum: $("#invNum").value,
      invDate: $("#invDate").value,
      billTo: $("#billTo").value,
      vehicle: $("#vehicle").value,
      footer: $("#footer").value,
      partsCost: partsCost.value,
      taxRate: taxRate.value,
      paid,
      lines,
      wm: sheet.getAttribute("data-watermark"),
      theme: {
        primary: getComputedStyle(document.documentElement).getPropertyValue("--color-primary").trim(),
        secondary: getComputedStyle(document.documentElement).getPropertyValue("--color-secondary").trim(),
        accent: getComputedStyle(document.documentElement).getPropertyValue("--color-accent").trim(),
        wmOpacity: getComputedStyle(document.documentElement).getPropertyValue("--wm-opacity").trim()
      }
    };
  }
  function persist(){
    localStorage.setItem("pdc_invoice_state", JSON.stringify(snapshot()));
  }
  function restore(){
    const saved = JSON.parse(localStorage.getItem("pdc_invoice_state") || "null");
    if(saved){
      $("#invNum").value = saved.invNum || autoNumber();
      $("#invDate").value = saved.invDate || today();
      $("#billTo").value = saved.billTo || "";
      $("#vehicle").value = saved.vehicle || "";
      $("#footer").value = saved.footer || "Thanks for your business! 30-day warranty on parts.";
      partsCost.value = saved.partsCost ?? "0";
      taxRate.value = saved.taxRate ?? "7";
      sheet.setAttribute("data-watermark", saved.wm || "on");
      wmState.textContent = (saved.wm === "off") ? "Off" : "On";

      if(saved.theme){
        document.documentElement.style.setProperty("--color-primary", saved.theme.primary || "#0a3d2e");
        document.documentElement.style.setProperty("--color-secondary", saved.theme.secondary || "#b22222");
        document.documentElement.style.setProperty("--color-accent", saved.theme.accent || "#f5c518");
        document.documentElement.style.setProperty("--wm-opacity", saved.theme.wmOpacity || "0.15");
      }

      (saved.lines || []).forEach(addRow);
      if(!saved.lines || saved.lines.length === 0){ seedRows(); }

      if(saved.paid){ statusTag.classList.remove("unpaid"); statusTag.classList.add("paid"); statusTag.textContent = "‚óè Paid"; }
    }else{
      $("#invNum").value = autoNumber();
      $("#invDate").value = today();
      seedRows();
    }

    const logo = localStorage.getItem("pdc_logo");
    if(logo){
      brandLogo.src = logo;
      ensureWatermarkCSS(logo);
    }else{
      // subtle placeholder
      brandLogo.src = "data:image/svg+xml;utf8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><rect width='100%' height='100%' fill='white'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='20' font-family='Arial' fill='${encodeURIComponent('#999')}'>LOGO</text></svg>`);
    }

    recalc();
  }

  function seedRows(){
    addRow({desc:"Inspection / Diagnostics", qty:1, rate:80, cost:0});
    addRow({desc:"Parts", qty:1, rate:0, cost:0});
  }

  function autoNumber(){
    // INV-YYMMDD-### (increments per day)
    const d = new Date();
    const y = String(d.getFullYear()).slice(-2);
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const key = `pdc_inv_seq_${y}${m}${day}`;
    const seq = (parseInt(localStorage.getItem(key) || "0",10) + 1);
    localStorage.setItem(key, String(seq));
    return `INV-${y}${m}${day}-${String(seq).padStart(3,"0")}`;
  }

  function today(){
    const d = new Date();
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${d.getFullYear()}-${mm}-${dd}`;
  }

  // Init
  restore();

  // Persist on unload
  window.addEventListener("beforeunload", persist);
})();
</script>
</body>
</html>
