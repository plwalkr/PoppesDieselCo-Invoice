<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JSON Buttons Test (v1.1.6)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 2rem; }
    .row { display:flex; gap:1rem; align-items:center; margin-bottom:1rem; }
    button { padding:.6rem 1rem; border-radius:.5rem; border:1px solid #999; cursor:pointer; }
    #log { white-space:pre-wrap; background:#f7f7f7; border:1px solid #ddd; padding:1rem; border-radius:.5rem; }
  </style>
</head>
<body>
  <h1>JSON Buttons Test (v1.1.6)</h1>
  <div class="row">
    <button id="exportJson">Save JSON</button>
    <button id="importJson">Load JSON</button>
    <input id="importJsonFile" type="file" accept="application/json" hidden>
  </div>
  <div id="log">Status: ready</div>
  <script>
    // Fake DB/UI to test round-trip
    let DB = { customers:[{id:'c1',name:'Test Customer'}], jobs:[{id:'j1',lines:[{type:'Part',desc:'Oil',qty:1,cost:10,unit:0}], photos:[], createdAt:new Date().toISOString()}] };
    let UI = {};
    function saveDB(){} function saveUI(){} function renderAll(){}
    function upgradeDB(){}
    function loadInvoice(){} // noop

    function __pdc_backupToJson(){
      const payload = { version:'v1.1.6', exportedAt:new Date().toISOString(), db:DB, ui:UI };
      const blob = new Blob([JSON.stringify(payload)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'test_backup.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
      document.getElementById('log').textContent = 'Exported test_backup.json';
    }
    function __pdc_restoreFromJson(obj){
      DB = obj.db || obj;
      document.getElementById('log').textContent = 'Imported. Jobs: '+(DB.jobs?.length||0)+', Customers: '+(DB.customers?.length||0);
    }
    function wire(){
      const expBtn = document.getElementById('exportJson');
      const impBtn = document.getElementById('importJson');
      const file   = document.getElementById('importJsonFile');
      expBtn.addEventListener('click', e=>{ e.preventDefault(); __pdc_backupToJson(); });
      impBtn.addEventListener('click', e=>{
        e.preventDefault();
        file.onchange = ()=>{
          const f = file.files?.[0]; if(!f) return;
          const r = new FileReader();
          r.onload = ()=>{ try{ const obj = JSON.parse(r.result||'{}'); __pdc_restoreFromJson(obj); } catch(err){ alert('Import failed: '+err.message); } };
          r.readAsText(f);
          file.value='';
        };
        file.click();
      });
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', wire, {once:true});
    else wire();
  </script>
</body>
</html>
