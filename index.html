<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="app-version" content="v1.4.0 HARDENED SINGLE-FILE" />
  <title>Poppe’s Diesel Co. — Shop Manager (v1.4.0 HARDENED SINGLE-FILE)</title>
  <style>
    :root {{ --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#93a1b0; --line:#334155; --btn:#111827; --btn-b:#475569; --badge:#111827; --badge-b:#374151; }}
    html,body {{ margin:0; background:var(--bg); color:var(--ink); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; }}
    .wrap {{ max-width: 1024px; margin: 40px auto; padding: 0 16px; }}
    h1 {{ font-size: 22px; margin: 0 0 10px 0; }}
    p.note {{ color: var(--muted); margin: 0 0 16px 0; }}
    .bar {{ display:flex; gap:10px; align-items:center; margin:16px 0 24px; flex-wrap:wrap; }}
    .btn {{ appearance:none; border:1px solid var(--btn-b); background:var(--btn); color:var(--ink); padding:8px 12px; border-radius:10px; cursor:pointer; }}
    .btn:hover {{ filter:brightness(1.12); }}
    input[type=file] {{ display:none; }}
    .card {{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }}
    .kv {{ display:grid; grid-template-columns: 160px 1fr; gap:6px 12px; }}
    .kv b {{ color: var(--muted); }}
    .badges {{ position:fixed; inset:auto .6rem .6rem auto; z-index:2147483000; }}
    .badge {{ background: var(--badge); border:1px solid var(--badge-b); border-radius:.6rem; padding:.35rem .6rem; font:11px/1.2 system-ui; margin-left:.5rem; display:inline-block; }}
    .badge.left {{ position:fixed; left:.6rem; bottom:.6rem; right:auto; }}
    #rescueBar {{ position:fixed; left:50%; transform:translateX(-50%); bottom:14px; z-index:2147483647; display:flex; gap:8px; align-items:center; background:#111827; color:#e5e7eb; border:1px solid #374151; border-radius:10px; padding:8px 10px; font:12px system-ui; }}
    #debug {{ white-space:pre-wrap; font:12px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#cbd5e1; background:#0a1224; border:1px solid #334155; border-radius:10px; padding:10px; margin-top:14px; max-height:220px; overflow:auto; }}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Shop Manager <span style="opacity:.75">(v1.4.0 HARDENED SINGLE-FILE)</span></h1>
    <p class="note">
      One-file, hardened build. It autosaves to your browser (IndexedDB) every ~5s and restores on load.
      Use JSON exports as off-computer backups. Buttons below are guaranteed clickable via a floating toolbar.
    </p>

    <div class="bar">
      <button id="exportJson" class="btn">Save JSON</button>
      <button id="importJson" class="btn">Load JSON</button>
      <input id="importJsonFile" type="file" accept="application/json" />
      <span id="status" class="note">Ready.</span>
    </div>

    <div class="card">
      <div class="kv">
        <b>Customers</b><span id="custCount">0</span>
        <b>Jobs</b><span id="jobCount">0</span>
        <b>Lines</b><span id="lineCount">0</span>
        <b>Photos</b><span id="photoCount">0</span>
      </div>
      <div id="debug" aria-live="polite">[debug] booting…</div>
    </div>
  </div>

  <!-- Floating toolbar (always on top, even if something prints as text) -->
  <div id="rescueBar">
    <button id="rescueSave" class="btn">Save JSON</button>
    <button id="rescueLoad" class="btn">Load JSON</button>
    <input id="rescueFile" type="file" accept="application/json" hidden>
    <span id="rescueMsg" style="opacity:.8">Toolbar ready</span>
  </div>

  <!-- Badges -->
  <div id="appVersionBadge" class="badge">v1.4.0 HARDENED SINGLE-FILE</div>
  <div id="saveStatusBadge" class="badge left">New session</div>

  <script>
  (function(){{
    'use strict';
    const meta = document.querySelector('meta[name="app-version"]');
    const APP_VERSION = (meta && meta.content) || 'v1.4.0 HARDENED SINGLE-FILE';
    const $ = (id)=>document.getElementById(id);
    const log = (msg)=>{{ const el=$('debug'); if(el){{ el.textContent += "\n" + msg; el.scrollTop = el.scrollHeight; }} }};

    function setText(id, v){{ const el=$(id); if(el) el.textContent = String(v); }}
    function setStatus(msg){{ setText('status', msg); log(msg); }}
    function setSaveBadge(msg){{ setText('saveStatusBadge', msg); }}
    function showVersion(){{ setText('appVersionBadge', APP_VERSION); }}

    // Minimal model (if your real DB/UI exists, we won't overwrite)
    if (!window.DB) {{ window.DB = {{ customers:[], jobs:[], settings:{{ defaultMarkup: 40 }} }}; }}
    if (!window.UI) {{ window.UI = {{}}; }}

    // Self-test counters
    function refreshCounters(){{ 
      const jobs = Array.isArray(DB.jobs) ? DB.jobs : [];
      const cust = Array.isArray(DB.customers) ? DB.customers : [];
      let lines=0, photos=0;
      for (const j of jobs){{ lines += (j.lines||[]).length; photos += (j.photos||[]).length; }}
      setText('custCount', cust.length);
      setText('jobCount', jobs.length);
      setText('lineCount', lines);
      setText('photoCount', photos);
    }}

    // IndexedDB
    const IDB_NAME='poppes_shop_mgr', IDB_VER=2, STORE='state';
    let _idb=null;
    function idbOpen(){{
      return new Promise((res,rej)=>{{ 
        const req = indexedDB.open(IDB_NAME, IDB_VER);
        req.onupgradeneeded = ()=>{{ const db=req.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE); }};
        req.onsuccess = ()=>res(req.result);
        req.onerror = ()=>rej(req.error);
      }});
    }}
    async function idb(){{ if(_idb) return _idb; _idb = await idbOpen(); return _idb; }}
    async function idbSet(k,v){{ const db=await idb(); await new Promise((res,rej)=>{{ const tx=db.transaction(STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); tx.objectStore(STORE).put(v,k); }}); }}
    async function idbGet(k){{ const db=await idb(); return await new Promise((res,rej)=>{{ const tx=db.transaction(STORE,'readonly'); tx.onerror=()=>rej(tx.error); const rq=tx.objectStore(STORE).get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error); }}); }}

    function deepClone(o){{ return JSON.parse(JSON.stringify(o)); }}
    function snapshot(){{ 
      try{{ return {{ version: APP_VERSION, at: new Date().toISOString(), db: window.DB?deepClone(window.DB):null, ui: window.UI?deepClone(window.UI):{{}} }}; }}
      catch(e){{ return {{ version: APP_VERSION, at: new Date().toISOString(), db:null, ui:null, error:String(e) }}; }}
    }}
    function hash(o){{ try{{ return btoa(unescape(encodeURIComponent(JSON.stringify(o)))).slice(0,24); }}catch(_ ){{ return 'x'; }} }}

    function doExport(){{ 
      try{{ 
        const blob = new Blob([JSON.stringify(snapshot())], {{type:'application/json'}});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'poppes_archive_'+ new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.json';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{{ URL.revokeObjectURL(a.href); a.remove(); }}, 400);
        setStatus('Exported archive.');
        setSaveBadge('Exported '+ new Date().toLocaleTimeString());
      }}catch(e){{ alert('Export failed: '+e.message); log('Export error: '+e.message); }}
    }}
    function doImport(file){{ 
      const r = new FileReader();
      r.onload = async ()=>{{ 
        try{{ 
          const obj = JSON.parse(r.result||'{{}}');
          const importedDB = obj.db || obj;
          const importedUI = obj.ui || {{}};
          if (!importedDB) {{ alert('Invalid archive file.'); return; }}
          window.DB = importedDB;
          window.UI = importedUI;
          if (typeof upgradeDB==='function') try{{ upgradeDB(); }}catch(_ ){{}}
          if (typeof saveDB==='function')   try{{ saveDB();   }}catch(_ ){{}}
          if (typeof saveUI==='function')   try{{ saveUI(UI); }}catch(_ ){{}}
          if (typeof renderAll==='function')try{{ renderAll();}}catch(_ ){{}}
          await idbSet('current', snapshot());
          refreshCounters();
          setStatus('Imported archive.');
          setSaveBadge('Imported '+ new Date().toLocaleTimeString());
          alert('Archive imported.');
        }}catch(e){{ alert('Import failed: '+e.message); log('Import error: '+e.message); }}
      }};
      r.readAsText(file);
    }}
    window.__pdc_export_full = doExport;
    window.__pdc_import_full = (f)=>doImport(f);

    let lastHash=null;
    async function bootRestore(){{ 
      try{{ 
        const snap = await idbGet('current');
        if (snap && snap.db){{ 
          window.DB = snap.db;
          window.UI = snap.ui || {{}};
          if (typeof upgradeDB==='function') try{{ upgradeDB(); }}catch(_ ){{}}
          if (typeof renderAll==='function') try{{ renderAll(); }}catch(_ ){{}}
          setSaveBadge('Restored '+ new Date().toLocaleTimeString());
          setStatus('Restored local snapshot.');
          lastHash = hash(window.DB||{{}});
        }} else {{ 
          setSaveBadge('New session');
        }}
      }}catch(_ ){{ setSaveBadge('New session'); }}
      refreshCounters();
    }}
    async function autosaveTick(){{ 
      try{{ 
        const snap = snapshot();
        if (!snap.db) return;
        const h = hash(snap.db);
        if (h !== lastHash){{ 
          await idbSet('current', snap);
          lastHash = h;
          setSaveBadge('Saved '+ new Date().toLocaleTimeString());
        }}
      }}catch(_ ){{}}
    }}

    function wire(){{ 
      const exp=$('exportJson'), imp=$('importJson'), file=$('importJsonFile');
      if (exp) exp.addEventListener('click', e=>{{ e.preventDefault(); doExport(); }});
      if (imp && file) imp.addEventListener('click', e=>{{ e.preventDefault(); file.onchange = ()=>{{ const f=file.files && file.files[0]; if(!f) return; doImport(f); file.value=''; }}; file.click(); }});

      // Always-on-top rescue toolbar (works even if something else blocks clicks)
      const rSave=$('rescueSave'), rLoad=$('rescueLoad'), rFile=$('rescueFile');
      if (rSave) rSave.addEventListener('click', (e)=>{{ e.preventDefault(); doExport(); }});
      if (rLoad && rFile) rLoad.addEventListener('click', (e)=>{{ e.preventDefault(); rFile.onchange=()=>{{ const f=rFile.files&&rFile.files[0]; if(!f) return; doImport(f); rFile.value=''; }}; rFile.click(); }});

      showVersion();
      setStatus('Ready.');
      setInterval(autosaveTick, 5000);
    }}

    if (document.readyState === 'loading') {{
      document.addEventListener('DOMContentLoaded', ()=>{{ bootRestore().then(wire); }}, {{once:true}});
    }} else {{
      bootRestore().then(wire);
    }}
  }} )();
  </script>
</body>
</html>
