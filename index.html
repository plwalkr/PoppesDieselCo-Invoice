<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="app-version" content="v1.3.1 SINGLE-FILE STABLE" />
  <title>Poppe’s Diesel Co. — Shop Manager (v1.3.1 SINGLE-FILE STABLE)</title>
  <style>
    :root { --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#93a1b0; --line:#334155; --btn:#111827; --btn-b:#475569; --badge:#111827; --badge-b:#374151; }
    html,body { margin:0; background:var(--bg); color:var(--ink); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { max-width: 1000px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 10px 0; }
    p.note { color: var(--muted); margin: 0 0 16px 0; }
    .bar { display:flex; gap:10px; align-items:center; margin:16px 0 24px; flex-wrap:wrap; }
    .btn { appearance:none; border:1px solid var(--btn-b); background:var(--btn); color:var(--ink); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn:hover { filter:brightness(1.12); }
    input[type=file] { display:none; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 12px; }
    .kv b { color: var(--muted); }
    .badges { position:fixed; inset:auto .6rem .6rem auto; z-index:2147483000; }
    .badge { background: var(--badge); border:1px solid var(--badge-b); border-radius:.6rem; padding:.35rem .6rem; font:11px/1.2 system-ui; margin-left:.5rem; display:inline-block; }
    .badge.left { position:fixed; left:.6rem; bottom:.6rem; right:auto; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Shop Manager <span style="opacity:.75">(v1.3.1 SINGLE-FILE STABLE)</span></h1>
    <p class="note">
      This is a one-file, durable build. It autosaves to your browser (IndexedDB) every ~5s and restores on load.
      Use JSON exports as off-computer backups. You can drop this over your existing file and still keep data.
    </p>

    <!-- Action bar (you can move these buttons anywhere in your real UI) -->
    <div class="bar">
      <button id="exportJson" class="btn">Save JSON</button>
      <button id="importJson" class="btn">Load JSON</button>
      <input id="importJsonFile" type="file" accept="application/json" />
      <span id="status" class="note">Ready.</span>
    </div>

    <!-- Tiny self-test so you know counts are sane after load/restore -->
    <div class="card">
      <div class="kv">
        <b>Customers</b><span id="custCount">0</span>
        <b>Jobs</b><span id="jobCount">0</span>
        <b>Lines</b><span id="lineCount">0</span>
        <b>Photos</b><span id="photoCount">0</span>
      </div>
    </div>
  </div>

  <!-- Badges -->
  <div id="appVersionBadge" class="badge">v1.3.1 SINGLE-FILE STABLE</div>
  <div id="saveStatusBadge" class="badge left">New session</div>

  <!-- Core logic: archive/restore + autosave (external-grade, inlined safely) -->
  <script>
  (function(){
    'use strict';
    const APP_VERSION = (document.querySelector('meta[name="app-version"]')?.content) || 'v1.3.1 SINGLE-FILE STABLE';

    // ------------- Helpers -------------
    const $ = (id)=>document.getElementById(id);
    function setText(id, v){ const el=$(id); if(el) el.textContent = String(v); }
    function setStatus(msg){ setText('status', msg); }
    function setSaveBadge(msg){ setText('saveStatusBadge', msg); }
    function showVersion(){ setText('appVersionBadge', APP_VERSION); }

    // ------------- Minimal data model -------------
    // If your app defines DB/UI elsewhere, this will respect it.
    // If not, we bootstrap a tiny example so you can see it working.
    if (!window.DB) {
      window.DB = {
        customers: [{ id:'c1', name:'Test Customer' }],
        jobs: [{
          id:'j1',
          createdAt: new Date().toISOString(),
          lines:[
            { type:'Part',  desc:'Oil', qty:1, cost:10, unit:14 },
            { type:'Labor', desc:'Change oil', qty:1, cost:60, unit:60 }
          ],
          photos:[]
        }],
        settings: { defaultMarkup: 40 }
      };
    }
    if (!window.UI) { window.UI = {}; }

    // ------------- Counters (self test) -------------
    function refreshCounters(){
      const jobs = Array.isArray(DB.jobs) ? DB.jobs : [];
      const cust = Array.isArray(DB.customers) ? DB.customers : [];
      let lines=0, photos=0;
      for (const j of jobs){ lines += (j.lines||[]).length; photos += (j.photos||[]).length; }
      setText('custCount', cust.length);
      setText('jobCount', jobs.length);
      setText('lineCount', lines);
      setText('photoCount', photos);
    }

    // ------------- IndexedDB tiny wrapper -------------
    const IDB_NAME='poppes_shop_mgr', IDB_VER=2, STORE='state';
    let _idb=null;
    function idbOpen(){ return new Promise((res,rej)=>{
      const req = indexedDB.open(IDB_NAME, IDB_VER);
      req.onupgradeneeded = ()=>{ const db=req.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE); };
      req.onsuccess = ()=>res(req.result);
      req.onerror = ()=>rej(req.error);
    });}
    async function idb(){ if(_idb) return _idb; _idb = await idbOpen(); return _idb; }
    async function idbSet(k,v){ const db=await idb(); await new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error); tx.objectStore(STORE).put(v,k); }); }
    async function idbGet(k){ const db=await idb(); return await new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); tx.onerror=()=>rej(tx.error); const rq=tx.objectStore(STORE).get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error); }); }

    // ------------- Snapshot -------------
    function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
    function snapshot(){
      try{
        const db = window.DB ? deepClone(window.DB) : null;
        const ui = window.UI ? deepClone(window.UI) : {};
        return { version: APP_VERSION, at: new Date().toISOString(), db, ui };
      }catch(e){
        return { version: APP_VERSION, at: new Date().toISOString(), db:null, ui:null, error:String(e) };
      }
    }
    function hash(o){ try{ return btoa(unescape(encodeURIComponent(JSON.stringify(o)))).slice(0,24); }catch(_){ return 'x'; } }

    // ------------- Export / Import -------------
    function doExport(){
      try{
        const blob = new Blob([JSON.stringify(snapshot())], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'poppes_archive_'+ new Date().toISOString().slice(0,19).replace(/[:T]/g,'-') + '.json';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 400);
        setStatus('Exported archive.');
        setSaveBadge('Exported '+ new Date().toLocaleTimeString());
      }catch(e){ alert('Export failed: '+e.message); }
    }
    function doImport(file){
      const r = new FileReader();
      r.onload = async ()=>{
        try{
          const obj = JSON.parse(r.result||'{}');
          const importedDB = obj.db || obj;
          const importedUI = obj.ui || {};
          if (!importedDB) { alert('Invalid archive file.'); return; }
          window.DB = importedDB;
          window.UI = importedUI;
          // Respect existing hooks if present in your app
          if (typeof upgradeDB==='function') upgradeDB();
          if (typeof saveDB==='function') saveDB();
          if (typeof saveUI==='function') saveUI(UI);
          if (typeof renderAll==='function') renderAll();
          await idbSet('current', snapshot());
          refreshCounters();
          setStatus('Imported archive.');
          setSaveBadge('Imported '+ new Date().toLocaleTimeString());
          alert('Archive imported.');
        }catch(e){ alert('Import failed: '+e.message); }
      };
      r.readAsText(file);
    }
    // Expose for console power-moves if you want
    window.__pdc_export_full = doExport;
    window.__pdc_import_full = f=>doImport(f);

    // ------------- Restore on boot + autosave -------------
    let lastHash=null;
    async function bootRestore(){
      try{
        const snap = await idbGet('current');
        if (snap && snap.db){
          window.DB = snap.db;
          window.UI = snap.ui || {};
          if (typeof upgradeDB==='function') upgradeDB();
          if (typeof renderAll==='function') renderAll();
          setSaveBadge('Restored '+ new Date().toLocaleTimeString());
          setStatus('Restored local snapshot.');
          lastHash = hash(window.DB||{});
        } else {
          setSaveBadge('New session');
        }
      }catch(_){
        setSaveBadge('New session');
      }
      refreshCounters();
    }
    async function autosaveTick(){
      try{
        const snap = snapshot();
        if (!snap.db) return;
        const h = hash(snap.db);
        if (h !== lastHash){
          await idbSet('current', snap);
          lastHash = h;
          setSaveBadge('Saved '+ new Date().toLocaleTimeString());
        }
      }catch(_){ /* no-op */ }
    }

    // ------------- Wire UI -------------
    function wire(){
      const exp=$('exportJson'), imp=$('importJson'), file=$('importJsonFile');
      if (exp) exp.addEventListener('click', e=>{ e.preventDefault(); doExport(); });
      if (imp && file) imp.addEventListener('click', e=>{
        e.preventDefault();
        file.onchange = ()=>{ const f=file.files && file.files[0]; if(!f) return; doImport(f); file.value=''; };
        file.click();
      });
      showVersion();
      setStatus('Ready.');
      setInterval(autosaveTick, 5000);
    }

    // ------------- Boot -------------
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', ()=>{ bootRestore().then(wire); }, {once:true});
    } else {
      bootRestore().then(wire);
    }
  })();
  </script>
</body>
</html>
