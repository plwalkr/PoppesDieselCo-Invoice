<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Poppeâ€™s Diesel Co. â€” Shop Manager (compact v1.2.1)</title>
<style>
:root{--bg:#e6cfae;--card:#fff;--ink:#0e111a;--border:#b6b09f;--accent:#0a3d2e;--ok:#1f6b55;--font:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:#0e111a;font-family:var(--font)}
header{position:sticky;top:0;background:var(--ink);color:#fff;padding:12px 16px;z-index:10}
h1{margin:0;font-size:18px}
nav.top{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
button,select,input,textarea{background:#fff;border:1px solid var(--border);color:#0e111a;padding:10px 12px;border-radius:10px;font-size:16px}
button{cursor:pointer}.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
main{padding:14px 14px 100px} .tab{display:none}.tab.active{display:block}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin:10px 0}
.table-wrap{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:auto}
table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
.actions{display:flex;flex-wrap:wrap;gap:8px}
.print-area{background:#fff;color:#000;border-radius:12px;padding:12px;margin-top:10px;position:relative;overflow:hidden}
.watermark{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;opacity:.08;pointer-events:none}
.badge{border:1px solid #000;border-radius:999px;padding:2px 7px;font-size:.9em}
.badge.estimate{background:#fdf1c4;color:#2b2100}.badge.invoice{background:#d9efe7;color:#0a3d2e}
#pdf{position:fixed;right:16px;bottom:74px;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:10px 14px;z-index:50}
/* Signature block */
.signatures{margin-top:12px;display:grid;gap:8px}.sig-row{display:grid;grid-template-columns:2fr 1fr;gap:12px;align-items:end}
.sig-line{border-bottom:1px solid #000;min-height:28px;display:flex;align-items:flex-end}
.sig-img{max-height:60px;display:none}
/* Notes */
.desc-wrap{display:flex;flex-direction:column;gap:6px}.lNote{min-height:60px;resize:vertical}
#overallNotes{min-height:100px;resize:vertical}
/* Print */
@media print{
  header,nav.bottom,nav.top,.actions,.modal,#debug{display:none!important}
  body{background:#fff}
}
</style>
</head>
<body>
<header>
  <h1>Poppeâ€™s Diesel Co. â€” Shop Manager <span class="badge" style="margin-left:8px">v1.2.1</span></h1>
  <nav class="top">
    <button class="primary" data-tab="invoice">Estimate / Invoice</button>
    <button data-tab="customers">Customers</button>
    <button data-tab="jobs">Jobs</button>
  </nav>
</header>

<main>
  <!-- Customers -->
  <section id="customers" class="tab">
    <h2>Customers</h2>
    <form id="custForm" class="grid">
      <input id="custName" placeholder="Full name" required>
      <input id="custPhone" placeholder="Phone">
      <input id="custEmail" placeholder="Email">
      <input id="custVehicle" placeholder="Vehicle">
      <button class="primary" type="submit">Add</button>
    </form>
    <div class="table-wrap"><table id="custTable"><thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Vehicle</th><th></th></tr></thead><tbody></tbody></table></div>
  </section>

  <!-- Jobs -->
  <section id="jobs" class="tab">
    <h2>Jobs</h2>
    <form id="jobForm" class="grid">
      <select id="jobCustomer" required></select>
      <input id="jobTitle" placeholder="Job title" required>
      <textarea id="jobNotes" placeholder="Job notes (symptoms, codes, etc.)"></textarea>
      <select id="jobStatus"><option>Open</option><option>In Progress</option><option>Done</option></select>
      <button class="primary" type="submit">Create Job</button>
    </form>
    <div class="table-wrap"><table id="jobsTable"><thead><tr><th>#</th><th>Customer</th><th>Title</th><th>Status</th><th></th></tr></thead><tbody></tbody></table></div>
  </section>

  <!-- Invoice -->
  <section id="invoice" class="tab active">
    <h2>Estimate / Invoice</h2>
    <form id="invForm" class="grid">
      <select id="invJob" required></select>
      <input id="invNo" placeholder="Doc #">
      <label>Type <select id="docType"><option>Estimate</option><option>Invoice</option></select></label>
      <label>Labor Rate ($/hr)<input id="laborRate" type="number" step="0.01" value="80"></label>
      <label>Sales Tax (%)<input id="salesTax" type="number" step="0.01" value="7"></label>
      <label>Payment Link<input id="payLink" placeholder="https://..."></label>
      <label>Email To<input id="emailTo" placeholder="customer@example.com"></label>
    </form>

    <div class="actions" style="margin-top:6px">
      <button id="addLabor">+ Labor</button>
      <button id="addPart">+ Part</button>
      <button id="applyMarkup">Apply Markup</button>
      <button id="sign">Collect Signatures</button>
      <button id="email">Email</button>
      <button id="pdf" class="primary">Generate PDF</button>
    </div>

    <div class="table-wrap" style="margin-top:8px">
      <table class="lines" id="lines">
        <thead><tr><th>Type</th><th>Description</th><th>Qty/Hrs</th><th>Cost $</th><th>Unit $</th><th>Line $</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="grid">
      <div class="card" style="background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px">
        <strong>Subtotal:</strong> <span id="sub">$0.00</span><br>
        <strong>Tax:</strong> <span id="tax">$0.00</span><br>
        <strong>Total:</strong> <span id="grand">$0.00</span>
      </div>
      <div class="card" style="background:#fff;border:1px solid var(--border);padding:10px;border-radius:10px">
        <strong>Technician Overall Notes</strong>
        <textarea id="overallNotes" placeholder="Explain diagnostics, verified checks, advisories."></textarea>
      </div>
    </div>

    <!-- Print preview -->
    <div id="preview" class="print-area">
      <div class="watermark"><div style="font-size:64px;font-weight:800;opacity:.2">Poppeâ€™s Diesel Co.</div></div>
      <div style="display:flex;justify-content:space-between;border-bottom:1px solid #000;padding-bottom:6px;margin-bottom:6px">
        <div>
          <h3 style="margin:0">Poppeâ€™s Diesel Co.</h3>
          <div>Columbus, IN</div><div>poppedieselco@gmail.com</div><div>(208) 243-7934</div>
        </div>
        <div>
          <div><strong>Doc #</strong> <span id="pInvNo">â€”</span></div>
          <div><strong>Date</strong> <span id="pDate">â€”</span></div>
          <div><strong>Type</strong> <span id="pType" class="badge estimate">Estimate</span></div>
        </div>
      </div>
      <div><strong>Bill To:</strong> <span id="pCust">â€”</span> <span id="pVeh" style="opacity:.8"></span></div>
      <table style="margin-top:6px"><thead><tr><th>Description</th><th>Qty/Hrs</th><th>Unit</th><th>Line $</th></tr></thead><tbody id="pLines"></tbody></table>
      <div id="pOverallBlock" style="margin-top:8px"></div>
      <div style="display:grid;gap:4px;justify-items:end;margin-top:8px">
        <div>Subtotal: <span id="pSub">$0.00</span></div>
        <div>Tax: <span id="pTax">$0.00</span></div>
        <div style="font-weight:700">Grand Total: <span id="pGrand">$0.00</span></div>
      </div>
      <!-- Signatures -->
      <div class="signatures">
        <div class="sig-row">
          <div>
            <div class="sig-line"><img id="pSigCustomer" class="sig-img" alt=""></div>
            <div style="font-size:.85em;color:#333">Customer Signature <span id="pSigCustomerName"></span> <span id="pSigCustomerDate" style="opacity:.7"></span></div>
          </div>
          <div><div class="sig-line"></div><div style="font-size:.85em;color:#333">Date</div></div>
        </div>
        <div class="sig-row">
          <div>
            <div class="sig-line"><img id="pSigManager" class="sig-img" alt=""></div>
            <div style="font-size:.85em;color:#333">Service Manager Signature <span id="pSigManagerName"></span> <span id="pSigManagerDate" style="opacity:.7"></span></div>
          </div>
          <div><div class="sig-line"></div><div style="font-size:.85em;color:#333">Date</div></div>
        </div>
      </div>
    </div>
  </section>
</main>

<nav class="bottom" style="position:fixed;left:0;right:0;bottom:0;background:#0e111a;color:#fff;display:flex;gap:8px;padding:10px;justify-content:center">
  <button class="primary" data-tab="invoice">ðŸ§¾</button>
  <button data-tab="customers">ðŸ‘¤</button>
  <button data-tab="jobs">ðŸ§°</button>
</nav>

<!-- Signature Modal -->
<div id="sigModal" class="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:60">
  <div class="panel" style="background:#fff;border:1px solid var(--border);border-radius:12px;max-width:720px;width:96%;padding:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="sigTitle" style="margin:0">Collect Signature</h3>
      <button id="sigClose">Close</button>
    </div>
    <div class="grid" style="margin-top:8px">
      <label>Signer Name <input id="sigName" placeholder="Printed name"></label>
      <label>Date <input id="sigDate" type="date"></label>
      <label>Role <select id="sigRole"><option value="customer">Customer</option><option value="manager">Service Manager</option></select></label>
    </div>
    <canvas id="sigPad" width="640" height="220" style="width:100%;background:#fff;border:1px dashed var(--border);border-radius:8px;margin-top:8px"></canvas>
    <div class="actions" style="margin-top:8px">
      <button id="sigClear">Clear</button>
      <button id="sigSave" class="primary">Save Signature</button>
    </div>
  </div>
</div>

<script>
/* Storage */
const KEY='pdc_compact_db_v121';
let DB=load()||seed(); upgrade(); save();
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(DB)); }catch(e){} }
function load(){ try{ const s=localStorage.getItem(KEY); return s?JSON.parse(s):null; }catch(e){ return null; } }
function seed(){
  const cid=crypto.randomUUID();
  return {customers:[{id:cid,name:'Shane Diesel',phone:'',email:'shane@example.com',vehicle:'2018 Ford Escape 2.0T'}],
          jobs:[{id:crypto.randomUUID(),customerId:cid,title:'Alternator + PCM diagnostics',status:'In Progress',lines:[
            {type:'Labor',desc:'Diagnostics',qty:1.5,cost:0,unit:80,note:'Verified concern under load.'},
            {type:'Part',desc:'Alternator',qty:1,cost:250,unit:324,note:'OEM preferred; core required.'}
          ],docType:'Estimate',invNo:'',paymentLink:'',overallNotes:'Initial assessment complete.',signatures:{customer:null,manager:null}}]};
}
function upgrade(){
  (DB.jobs||[]).forEach(j=>{
    if(!j.signatures) j.signatures={customer:null,manager:null};
    j.lines=(j.lines||[]).map(l=>Object.assign({note:''},l));
    if(typeof j.overallNotes==='undefined') j.overallNotes='';
  });
}

/* DOM helpers */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function fmt(n){return '$'+Number(n||0).toFixed(2);}

/* Tabs */
$$('[data-tab]').forEach(b=>b.addEventListener('click',()=>{ $$('.tab').forEach(t=>t.classList.remove('active')); $('#'+b.dataset.tab).classList.add('active'); window.scrollTo({top:0,behavior:'smooth'});}))

/* Customers */
$('#custForm').addEventListener('submit',e=>{e.preventDefault();const c={id:crypto.randomUUID(),name:$('#custName').value.trim(),phone:$('#custPhone').value.trim(),email:$('#custEmail').value.trim(),vehicle:$('#custVehicle').value.trim()}; if(!c.name) return; DB.customers.push(c); save(); renderCustomers(); renderJobCustomer(); e.target.reset(); });
function renderCustomers(){
  const tb=$('#custTable tbody'); tb.innerHTML='';
  DB.customers.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.name}</td><td>${c.phone||''}</td><td>${c.email||''}</td><td>${c.vehicle||''}</td><td><button data-delc="${c.id}">Delete</button></td>`;
    tb.appendChild(tr);
  });
  $$('button[data-delc]').forEach(btn=>btn.addEventListener('click',()=>{
    const id=btn.getAttribute('data-delc');
    if(!confirm('Delete this customer and all their jobs?')) return;
    DB.jobs=DB.jobs.filter(j=>j.customerId!==id); DB.customers=DB.customers.filter(c=>c.id!==id); save(); renderCustomers(); renderJobs(); renderJobCustomer();
  }));
}
renderCustomers();

/* Jobs */
function renderJobCustomer(){
  $('#jobCustomer').innerHTML='<option value="">Selectâ€¦</option>'+DB.customers.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  renderInvJobOptions();
}
$('#jobForm').addEventListener('submit',e=>{
  e.preventDefault();
  const j={id:crypto.randomUUID(),customerId:$('#jobCustomer').value,title:$('#jobTitle').value.trim(),status:$('#jobStatus').value,lines:[],docType:'Estimate',invNo:'',paymentLink:'',overallNotes:'',signatures:{customer:null,manager:null}};
  if(!j.customerId||!j.title) return; DB.jobs.push(j); save(); renderJobs(); renderJobCustomer(); e.target.reset();
  if(DB.jobs.length===1){ $('#invJob').value=j.id; loadInvoice(j.id); }
});
function renderJobs(){
  const tb=$('#jobsTable tbody'); tb.innerHTML='';
  DB.jobs.forEach(j=>{
    const c=DB.customers.find(x=>x.id===j.customerId);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${j.id.slice(0,6)}</td><td>${c?c.name:'â€”'}</td><td>${j.title}</td><td>${j.status}</td><td><button data-open="${j.id}">Open</button></td>`;
    tb.appendChild(tr);
  });
  $$('button[data-open]').forEach(b=>b.addEventListener('click',()=>{ $('[data-tab="invoice"]').click(); $('#invJob').value=b.getAttribute('data-open'); loadInvoice(b.getAttribute('data-open')); }));
}
renderJobs();

/* Invoice pick */
function renderInvJobOptions(){
  const sel=$('#invJob');
  sel.innerHTML='<option value="">Select jobâ€¦</option>'+DB.jobs.map(j=>{
    const c=DB.customers.find(x=>x.id===j.customerId);
    return `<option value="${j.id}">${c?c.name:'â€”'} â€” ${j.title}</option>`;
  }).join('');
}
$('#invJob').addEventListener('change',e=>loadInvoice(e.target.value));

/* Lines */
function addLine(type,desc,qty,unit,cost,note){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td><select class="lType"><option ${type==='Labor'?'selected':''}>Labor</option><option ${type==='Part'?'selected':''}>Part</option></select></td>
  <td><div class="desc-wrap"><input class="lDesc" value="${desc||''}" placeholder="${type==='Labor'?'Diagnostics / R&R':'Part name (SKU) â€” Vendor'}"><textarea class="lNote" placeholder="Tech note for this line (prints)">${note||''}</textarea></div></td>
  <td><input class="lQty" type="number" step="0.01" value="${qty||1}"></td>
  <td><input class="lCost" type="number" step="0.01" value="${(cost!=null)?cost:0}"></td>
  <td><input class="lUnit" type="number" step="0.01" value="${unit||0}"></td>
  <td class="lLine">$0.00</td>`;
  $('#lines tbody').appendChild(tr);
  ['change','input'].forEach(evt=>['.lType','.lDesc','.lQty','.lCost','.lUnit','.lNote'].forEach(sel=>tr.querySelector(sel).addEventListener(evt,persistLines)));
  persistLines();
}
$('#addLabor').addEventListener('click',()=>{ if(!ensureJob()) return; addLine('Labor','',1,Number($('#laborRate').value||80),0,''); });
$('#addPart').addEventListener('click',()=>{ if(!ensureJob()) return; addLine('Part','',1,0,0,''); });

function rowsToLines(){
  return $$('#lines tbody tr').map(tr=>({type:tr.querySelector('.lType').value,desc:tr.querySelector('.lDesc').value,qty:Number(tr.querySelector('.lQty').value||0),cost:Number(tr.querySelector('.lCost').value||0),unit:Number(tr.querySelector('.lUnit').value||0),note:tr.querySelector('.lNote').value.trim()}));
}
function persistLines(){
  const j=currentJob(); if(!j) return;
  j.lines=rowsToLines();
  j.invNo=$('#invNo').value.trim();
  j.docType=$('#docType').value;
  j.paymentLink=$('#payLink').value.trim();
  j.emailTo=$('#emailTo').value.trim();
  j.overallNotes=$('#overallNotes').value||'';
  save(); recalc(); updatePreview(); renderJobs();
}
function applyMarkup(){
  const mu=0.4;
  $$('#lines tbody tr').forEach(tr=>{
    if(tr.querySelector('.lType').value==='Part'){
      const cost=Number(tr.querySelector('.lCost').value||0);
      tr.querySelector('.lUnit').value=(cost*(1+mu)).toFixed(2);
    }
  });
  persistLines();
}
$('#applyMarkup').addEventListener('click',applyMarkup);

/* Totals */
function recalc(){
  const j=currentJob(); if(!j) return;
  let subtotal=0;
  const lr=Number($('#laborRate').value||80);
  j.lines.forEach((l,i)=>{ if(l.type==='Labor' && (!l.unit||l.unit===0)) l.unit=lr; subtotal+= (l.qty||0)*(l.unit||0); const row=$$('#lines tbody tr')[i]; if(row) row.querySelector('.lLine').textContent=fmt((l.qty||0)*(l.unit||0)); });
  const tax=subtotal*(Number($('#salesTax').value||0)/100);
  const grand=subtotal+tax;
  $('#sub').textContent=fmt(subtotal); $('#tax').textContent=fmt(tax); $('#grand').textContent=fmt(grand);
  $('#pSub').textContent=fmt(subtotal); $('#pTax').textContent=fmt(tax); $('#pGrand').textContent=fmt(grand);
}
$('#laborRate').addEventListener('input',persistLines);
$('#salesTax').addEventListener('input',persistLines);

/* Preview */
function updatePreview(){
  const j=currentJob();
  $('#pInvNo').textContent=$('#invNo').value.trim()||'DRAFT';
  $('#pDate').textContent=new Date().toLocaleDateString();
  const t=$('#docType').value; const badge=$('#pType'); badge.textContent=t; badge.className='badge '+(t==='Invoice'?'invoice':'estimate');
  const c=j?DB.customers.find(x=>x.id===j.customerId):null;
  $('#pCust').textContent=c?c.name:'â€”'; $('#pVeh').textContent=c?(' '+(c.vehicle||'')) : '';
  const tbody=$('#pLines'); tbody.innerHTML='';
  (j?j.lines:[]).forEach(l=>{
    const tr=document.createElement('tr'); const line=(Number(l.qty)||0)*(Number(l.unit)||0);
    tr.innerHTML=`<td>${l.type}: ${l.desc||''}</td><td>${l.qty||0}</td><td>${fmt(l.unit||0)}</td><td>${fmt(line)}</td>`; tbody.appendChild(tr);
    if(l.note){ const n=document.createElement('tr'); n.innerHTML=`<td colspan="4" style="font-style:italic;color:#333;white-space:pre-wrap">Note: ${escapeHtml(l.note)}</td>`; tbody.appendChild(n); }
  });
  const blk=$('#pOverallBlock'); blk.innerHTML=''; if(j&&j.overallNotes){ blk.innerHTML = `<h4 style="margin:6px 0 4px 0">Technician Overall Notes</h4><div style="white-space:pre-wrap;line-height:1.35">${escapeHtml(j.overallNotes)}</div>`; }
  // signatures
  setSig('customer'); setSig('manager');
  function setSig(role){
    const data=j && j.signatures? j.signatures[role]:null;
    const img=role==='customer'?$('#pSigCustomer'):$('#pSigManager');
    const nameEl=role==='customer'?$('#pSigCustomerName'):$('#pSigManagerName');
    const dateEl=role==='customer'?$('#pSigCustomerDate'):$('#pSigManagerDate');
    if(data && data.dataUrl){ img.src=data.dataUrl; img.style.display='block'; nameEl.textContent = data.name ? 'â€” '+data.name : ''; dateEl.textContent = data.date? '('+data.date+')':''; } else { img.style.display='none'; nameEl.textContent=''; dateEl.textContent=''; }
  }
  function escapeHtml(s){ return s.replace(/[&<>\"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }
}

/* Job helpers */
function currentJob(){ const id=$('#invJob').value; return DB.jobs.find(j=>j.id===id); }
function ensureJob(){ const j=currentJob(); if(!j && DB.jobs.length===1){ $('#invJob').value=DB.jobs[0].id; loadInvoice(DB.jobs[0].id); return DB.jobs[0]; } if(!j) alert('Pick a job in the dropdown first.'); return j; }
function loadInvoice(id){
  const j=DB.jobs.find(x=>x.id===id); if(!j) return;
  $('#lines tbody').innerHTML='';
  (j.lines||[]).forEach(l=>addLine(l.type,l.desc,l.qty,l.unit,l.cost,l.note));
  $('#invNo').value=j.invNo||''; $('#docType').value=j.docType||'Estimate'; $('#payLink').value=j.paymentLink||'';
  const c=DB.customers.find(x=>x.id===j.customerId); $('#emailTo').value=(c&&c.email)||'';
  $('#overallNotes').value=j.overallNotes||'';
  updatePreview(); recalc();
}

/* Email */
$('#email').addEventListener('click',()=>{
  const j=ensureJob(); if(!j) return;
  const to=encodeURIComponent($('#emailTo').value.trim()||'');
  const subj=encodeURIComponent(`${j.docType} ${j.invNo||''} from Poppeâ€™s Diesel Co.`);
  const body=encodeURIComponent(`Hello,\n\nYour ${j.docType} total is ${$('#grand').textContent}.\nPayment link: ${j.paymentLink||''}\n\nThank you for supporting local.\n\nâ€” Poppeâ€™s Diesel Co.`);
  location.href=`mailto:${to}?subject=${subj}&body=${body}`;
});

/* PDF / Print â€” smaller professional font */
$('#pdf').addEventListener('click',()=>{
  updatePreview();
  const css = 'html,body{margin:0;padding:0}body{font-family:'+CSS.escape(getComputedStyle(document.body).fontFamily)+';font-size:9pt;line-height:1.35;color:#000}'+
              '.print-area{padding:8px 10px;position:relative}'+
              'h3{margin:0 0 2px 0}table{width:100%;border-collapse:collapse;margin-top:4px}th,td{border-bottom:1px solid #000;padding:5px;vertical-align:top}'+
              '.badge{border:1px solid #000;border-radius:9999px;padding:1px 6px;font-size:8.5pt}'+
              '.sig-img{max-height:50px;display:block}';
  const html='<!DOCTYPE html><html><head><meta charset="utf-8"><title>Invoice</title><style>'+css+'</style></head><body>'+document.getElementById('preview').outerHTML+'</body></html>';
  const w=window.open('','_blank'); if(!w){ alert('Allow popâ€‘ups to print.'); return; } w.document.write(html); w.document.close(); setTimeout(()=>{try{w.print();}catch(e){}},300);
});

/* Inputs */
$('#invNo').addEventListener('input',persistLines);
$('#docType').addEventListener('change',persistLines);
$('#payLink').addEventListener('input',persistLines);
$('#emailTo').addEventListener('input',persistLines);
$('#overallNotes').addEventListener('input',persistLines);

/* Signature modal + pad */
const sigModal=$('#sigModal'); const pad=$('#sigPad'); const ctx=pad.getContext('2d'); ctx.lineWidth=2; ctx.lineCap='round';
function openSig(role){ sigModal.style.display='flex'; $('#sigRole').value=role||'customer'; $('#sigTitle').textContent='Collect '+($('#sigRole').value==='customer'?'Customer':'Service Manager')+' Signature'; $('#sigDate').value = new Date().toISOString().slice(0,10); $('#sigName').value=''; clearPad(); }
$('#sign').addEventListener('click',()=>{ if(!ensureJob()) return; openSig('customer'); });
$('#sigClose').addEventListener('click',()=> sigModal.style.display='none');
function pos(e){ const r=pad.getBoundingClientRect(); if(e.touches&&e.touches.length) return {x:e.touches[0].clientX-r.left,y:e.touches[0].clientY-r.top}; return {x:e.clientX-r.left,y:e.clientY-r.top}; }
let drawing=false,last=null;
function start(e){ drawing=true; last=pos(e); e.preventDefault(); }
function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault(); }
function end(){ drawing=false; last=null; }
function clearPad(){ ctx.clearRect(0,0,pad.width,pad.height); }
pad.addEventListener('mousedown',start); pad.addEventListener('mousemove',move); document.addEventListener('mouseup',end);
pad.addEventListener('touchstart',start,{passive:false}); pad.addEventListener('touchmove',move,{passive:false}); pad.addEventListener('touchend',end);
$('#sigClear').addEventListener('click',clearPad);
$('#sigSave').addEventListener('click',()=>{
  const j=ensureJob(); if(!j) return;
  const url=pad.toDataURL('image/png'); const role=$('#sigRole').value; const name=$('#sigName').value.trim(); const date=$('#sigDate').value;
  j.signatures[role]={dataUrl:url,name,date,savedAt:new Date().toISOString()};
  save(); updatePreview(); alert('Signature saved.'); sigModal.style.display='none';
});

/* Initial render */
renderJobCustomer(); renderInvJobOptions();
if(DB.jobs[0]){ $('#invJob').value=DB.jobs[0].id; loadInvoice(DB.jobs[0].id); }
</script>
</body>
</html>
